buildscript {
    repositories {
        maven {
            url "https://plugins.gradle.org/m2/"
        }
    }
    dependencies {
        classpath "org.gint:gint-atlassian:3.8.4"
    }
}

apply plugin: 'org.gint.atlassian'
apply from: gint.resourceDirectory +'/src/itest-postfunction1/postfunction.gradle'

def functionKey =	info ?.isCloud ? "com.atlassian.plugins.atlassian-connect-plugin:com.innovalog.${testCloudBuild}__LinkIssuesFunction" : 'com.innovalog.jmwe.jira-misc-workflow-extensions:link-issues-function'

def jqlExpressionToLinkIssue = "project = $projectName and issueType = Task and summary ~ JMWE_LinkIssue"

def numberOfIssues = 10

def issuesToLink = [
        returnByJql : info?.isCloud ? /"jql":"$jqlExpressionToLinkIssue"/ : ["jql=$jqlExpressionToLinkIssue"],
]

def maxIssues = [
        zero : info?.isCloud ? /"maxIssues":"0"/ : [ "maxIssues=0"],
        one : info?.isCloud ? /"maxIssues":"1"/ : [ "maxIssues=1"],
        two : info?.isCloud ? /"maxIssues":"2"/ : [ "maxIssues=2"],
        three : info?.isCloud ? /"maxIssues":"3"/ : [ "maxIssues=3"],
]

def selectedLinkType = [
        Blocks: info?.isCloud ? /"selectedLinkType":"$relatedIssue.linkByBlock"/ : ["selectedLinkType=$linkByBlock"],
        Cloners: info?.isCloud ? /"selectedLinkType":"$relatedIssue.linkByClones"/ : ["selectedLinkType=$linkByClones"],
        Duplicate: info?.isCloud ? /"selectedLinkType":"$relatedIssue.linkByDuplicates"/ : ["selectedLinkType=$linkByDuplicates"],
        Relates: info?.isCloud ? /"selectedLinkType":"$relatedIssue.linkByRelatesTo"/ : ["selectedLinkType=$linkByRelatesTo"],
]

def useGroovyFilter = [
        no : info ?.isCloud ? /"useFilter":false,"filterExpression:""/ : ["useGroovyFilter=false"],
        yes : info ?.isCloud ? /"useFilter":true,"filterExpression:""/ : ["useGroovyFilter=true"]
]

selectedLinkType.eachWithIndex { key,  value, i ->
        def transition = 'linkIssuesToCurrentIssueByType'
        def cloud =  "{\"conditionalExecution\":false,\"jql\":\"$jqlExpressionToLinkIssue\",$value,\"maxIssues\":\"1\",\"runAsType\":\"addonUser\",\"useFilter\":false,\"filterExpression\":\"\"}"
        def server =  [value , issuesToLink.returnByJql , maxIssues.one ,  useGroovyFilter.no , runAsUser.currentUser , conditionalExecution.false]
        addTransitionFunction(transition + key, 'postfunction', info?.isCloud ? cloud : server, functionKey )
}

selectedLinkType.take(1).eachWithIndex { key,  value, i ->
    def transition = 'linkIssuesToCurrentIssueIfConditionTrueByType'
    def cloud =  "{\"conditionalExecution\":true,\"conditionalExecutionScript\":\"$nunjuckExpression.checkPriorityHigh\",\"jql\":\"$jqlExpressionToLinkIssue\",$value,\"maxIssues\":\"1\",\"runAsType\":\"addonUser\",\"useFilter\":false,\"filterExpression\":\"\"}"
    def server =  [value , issuesToLink.returnByJql , maxIssues.one ,  useGroovyFilter.no , runAsUser.currentUser , conditionalExecution.true]
    addTransitionFunction(transition + key, 'postfunction', info?.isCloud ? cloud : server, functionKey )
}

[
        'numberOfIssuesToBeLinked'
].each {
    def cloud =  "{\"conditionalExecution\":false,\"jql\":\"$jqlExpressionToLinkIssue\",\"selectedLinkType\":\"$relatedIssue.linkByBlock\",\"maxIssues\":\"$numberOfIssues\",\"runAsType\":\"addonUser\",\"useFilter\":false,\"filterExpression\":\"\"}"
    def server =  [selectedLinkType.Blocks , issuesToLink.returnByJql , "maxIssues=$numberOfIssues" ,  useGroovyFilter.no , runAsUser.currentUser , conditionalExecution.false]
    addTransitionFunction(it, 'postfunction', info?.isCloud ? cloud : server, functionKey )
}

createWorkflowScheme()
createProject()

def defaultIssue = createIssue([type: 'Task', summary: 'JMWE_Issue'], 'defaultIssue')
def defaultIssue1 = createIssue([type: 'Task', summary: 'JMWE_LinkIssue'], 'defaultIssue1')

def issue = {->defaultIssue[]}

selectedLinkType.eachWithIndex { linkType, value, i ->
    [
            'linkIssuesToCurrentIssueByType',
    ].each {
        def expectedOutput= "1 links for issue";
        gint.taskHelper.add([
                [action    : 'transitionIssue',
                 sleep: info?.isCloud ? 5000 : 0,
                 ext: " ::" + it + linkType + i ,
                 parameters: [
                         transition: it + linkType,
                         issue     : { -> defaultIssue[] },
                 ],
                ],
                [action: 'getLinkList',
                 sleep: info?.isCloud ? 5000 : 0,
                 ext: ":issues to be linked by $linkType by postfunction: after transition issue with" + it + linkType,
                 parameters  : [
                         issue     : { -> defaultIssue[] },
                         outputType: "text",
                         select    : "Type Name:$linkType",
                         columns   : "Issue,'To Issue','Type Name'"
                 ],
                        data: ["1 links for issue: $issue"],
                 finalClosure: { Task task ->
                     def output = "$task.outData"
                     if (output.contains(expectedOutput)) {
                         gint.helper.log("Test passed for transition", it)
                     } else {
                         gint.helper.log("Test failed for transition", it)
                         assert output.contains(expectedOutput)
                     }
                 }
                ],
                [action: "deleteLink",
                 sleep: info?.isCloud ? 5000 : 0,
                 ext: ":issue link by postfunction after transition issue with _ $it$linkType:",
                 parameters: [
                         issue: {->defaultIssue[]},
                         toIssue: {-> defaultIssue1[]},
                         link: linkType
                 ]
                ],
                [action: 'getLinkList',
                 sleep: info?.isCloud ? 5000 : 0,
                 ext: ":issues to be linked by $linkType :" + it + linkType ,
                 parameters  : [
                         issue     : { -> defaultIssue[] },
                         outputType: "text",
                         select    : "Type Name:$linkType",
                         columns   : "Issue,'To Issue','Type Name'"
                 ],
                 data: ["0 links for issue: $issue"],
                 finalClosure: { Task task ->
                     def output = "$task.outData"
                     !output.contains(expectedOutput)
                 }
                ],
        ]
        )
    }
}

selectedLinkType.take(1).eachWithIndex { linkType, value, i ->
    [
            'linkIssuesToCurrentIssueIfConditionTrueByType'
    ].each {
        ["High","Low"].eachWithIndex{ priority, idx ->
            def expectedOutput;
            if(priority == "High"){
                expectedOutput = "1 links for issue"
            }
            else{
                expectedOutput = "0 links for issue"
            }
            gint.taskHelper.add([
                    [action: 'setFieldValue',
                     sleep: info?.isCloud ? 5000 : 0,
                     ext : ": Of priority $priority:before transition issue with _ $it$linkType$i",
                     parameters: [
                             issue: {-> defaultIssue[]},
                             field: "Priority",
                             value: priority
                     ]
                    ],
                    [action    : 'transitionIssue',
                     sleep: info?.isCloud ? 5000 : 0,
                     ext: " : when priority is $priority :" + it + linkType + i ,
                     parameters: [
                             transition: it + linkType,
                             issue     : { -> defaultIssue[] },
                     ],
                    ],
                    [action: 'getLinkList',
                     sleep: info?.isCloud ? 5000 : 0,
                     ext: ":issues to be linked by $linkType by postfunction_ when priority is $priority: after transition issue with" + it + i ,
                     parameters  : [
                             issue     : { -> defaultIssue[] },
                             outputType: "text",
                             select    : "Type Name:$linkType",
                             columns   : "Issue,'To Issue','Type Name'"
                     ],
                     finalClosure: { Task task ->
                         def output = "$task.outData"
                         if (output.contains(expectedOutput)) {
                             gint.helper.log("Test passed for transition", it)
                         } else {
                             gint.helper.log("Test failed for transition", it)
                             assert output.contains(expectedOutput)
                         }
                     }
                    ],
            ]
            )
            if(priority != "Low") {
                gint.taskHelper.add([
                        [action    : "deleteLink",
                         sleep: info?.isCloud ? 5000 : 0,
                         ext       : ":issue link by postfunction after transition issue with _ $it$linkType$i _when priority is $priority:",
                         parameters: [
                                 issue  : { -> defaultIssue[] },
                                 toIssue: { -> defaultIssue1[] },
                                 link   : linkType
                         ]
                        ],
                        [action      : 'getLinkList',
                         sleep: info?.isCloud ? 5000 : 0,
                         ext         : ":issues to be linked by $linkType when priority is $priority:" + it + linkType + i,
                         parameters  : [
                                 issue     : { -> defaultIssue[] },
                                 outputType: "text",
                                 select    : "Type Name:$linkType",
                                 columns   : "Issue,'To Issue','Type Name'"
                         ],
                         finalClosure: { Task task ->
                             def output = "$task.outData"
                             !output.contains(expectedOutput)
                         }
                        ],
                ]
                )
            }
        }

    }
}

(1..numberOfIssues).each {
    gint.taskHelper.add(
            action: 'createIssue', ext: ":create issue number: $it",
            parameters: [
                    project: projectName,
                    type: "Task",
                    summary: "JMWE_LinkIssue",
            ]
    )
}

[
        'numberOfIssuesToBeLinked'
].each {
    gint.taskHelper.add([
            [action    : 'transitionIssue',
             sleep: info?.isCloud ? 5000 : 0,
             ext: ":with:" + it ,
             parameters: [
                     transition: it,
                     issue     : { -> defaultIssue[] },
             ],
            ],
            [action: 'getLinkList',
             sleep: info?.isCloud ? 5000 : 0,
             ext: ":Check number issues to be linked by blocks link type postfunction is_ $numberOfIssues: after transition issue with" + it ,
             parameters  : [
                     issue     : { -> defaultIssue[] },
                     outputType: "text",
                     select    : "Type Name:Blocks",
                     columns   : "Issue,'To Issue','Type Name'"
             ],
             finalClosure: { Task task ->
                 def output = "$task.outData"
                 if (output.contains("$numberOfIssues links for issue")) {
                     gint.helper.log("Test passed for transition", "unlinkIssuesWhichReturnsConditionTrue")
                 } else {
                     gint.helper.log("Test failed for transition", "unlinkIssuesWhichReturnsConditionTrue")
                     assert output.contains("$numberOfIssues links for issue")
                 }
             }
            ],
    ],
    )
}



