buildscript {
    repositories {
        maven {
            url "https://plugins.gradle.org/m2/"
        }
    }
    dependencies {
        classpath "org.gint:gint-atlassian:3.8.4"
    }
}

apply plugin: 'org.gint.atlassian'
apply from: gint.resourceDirectory +'/src/itest-postfunction1/postfunction.gradle'

def script = [
        setSummary : [ "groovyExpression=issue.setFieldValue('Summary','test_summary')","scriptDescription=" ],
        currentUser : [ "groovyExpression=issue.setFieldValue('Summary','runAsCurrentUser')","scriptDescription=" ],
        specificUser : [ "groovyExpression=issue.setFieldValue('Summary','runAsSpecificUser')","scriptDescription=" ],
        userInFieldAssignee : [ "groovyExpression=issue.setFieldValue('Summary','runAsUserInFieldAssignee')","scriptDescription=" ],
        userInFieldReporter : [ "groovyExpression=issue.setFieldValue('Summary','runAsUserInFieldReporter')","scriptDescription=" ],
        userInFieldCreator : [ "groovyExpression=issue.setFieldValue('Summary','runAsUserInFieldCreator')","scriptDescription=" ],
        userFromScript : [ "groovyExpression=issue.setFieldValue('Summary','runAsUserFromScript')","scriptDescription=" ],
]

def functionKey = info?.isCloud ? "com.atlassian.plugins.atlassian-connect-plugin:com.innovalog.${testCloudBuild}__ScriptedPostFunction" : 'com.innovalog.jmwe.jira-misc-workflow-extensions:groovy-function'

String scriptForSummary = "{{ '/rest/api/2/issue/:issue' | callJira(verb=('PUT'), params={'issue':issue.key}, body={'fields': {'summary': 'test_summary'} }) }}"

['setSummaryByScript'].each {
    def server =  script.setSummary
    def cloud =  "{\"script\":\"$scriptForSummary\",\"scriptDescription\":\"\"}"
    addTransitionFunction(it, 'postfunction', info?.isCloud ? cloud : server, functionKey)
}

['runAsCurrentUser'].each {
    def server =  script.currentUser + runAsUser.currentUser
    def cloud =  ""
    if(!isCloud) {
        addTransitionFunction(it , 'postfunction', info?.isCloud ? cloud : server, functionKey )
        moveTransitionFunction(it, 4)
    }
}

['runAsUserInFieldReporter'].each {
    def server =  script.userInFieldReporter + runAsUser.userInFieldReporter
    def cloud =  ""
    if(!isCloud) {
        addTransitionFunction(it , 'postfunction', info?.isCloud ? cloud : server, functionKey )
        moveTransitionFunction(it, 4)
    }
}
['runAsUserInFieldCreator'].each {
    def server =  script.userInFieldCreator + runAsUser.userInFieldCreator
    def cloud =  ""
    if(!isCloud) {
        addTransitionFunction(it , 'postfunction', info?.isCloud ? cloud : server, functionKey )
        moveTransitionFunction(it, 4)
    }
}

['runAsUserFromScript'].each {
    def server =  script.userFromScript + runAsUser.userFromScript
    def cloud =  ""
    if(!isCloud) {
        addTransitionFunction(it, 'postfunction', info?.isCloud ? cloud : server, functionKey )
        moveTransitionFunction(it, 4)
    }
}

['runAsUserInFieldAssignee'].each {
    def server =  script.userInFieldAssignee + runAsUser.userInFieldAssignee
    def cloud =  ""
    if(!isCloud) {
        addTransitionFunction(it, 'postfunction', info?.isCloud ? cloud : server, functionKey )
        moveTransitionFunction(it, 4)
    }
}
['runAsSpecificUser'].each {
    def server =  script.specificUser + runAsUser.specificUser
    def cloud =  ""
    if(!isCloud) {
        addTransitionFunction(it, 'postfunction', info?.isCloud ? cloud : server, functionKey )
        moveTransitionFunction(it, 4)
    }
}

createWorkflowScheme()
createProject()


def defaultIssue = createIssue([type: 'Task', summary: 'JMWE_Issue'], 'defaultIssue')

// checking the current status To Do and previous status In Progress
[
        'setSummaryByScript'
].each {
        gint.taskHelper.add([
                [action    : 'transitionIssue', ext: " : " + it,
                 sleep     : sleep,
                 parameters: [
                         transition: it,
                         issue     : { -> defaultIssue[] },
                 ],
                ],
                [action    : 'getFieldValue', ext: ": Chack :" + it,
                 sleep     : sleep,
                 parameters: [
                         issue: { -> defaultIssue[] },
                         field: "Summary",
                 ],
                 data      : ["Summary . . . . . . . . . . . : test_summary"],
                ]

        ])
}

[
        'runAsCurrentUser',
        'runAsUserInFieldReporter',
        'runAsUserInFieldCreator',
        'runAsUserFromScript',
        'runAsSpecificUser',
].each {
    if(!isCloud) {
        gint.taskHelper.add([
                [action    : 'transitionIssue', ext: " : " + it,
                 sleep     : sleep,
                 parameters: [
                         transition: it,
                         issue     : { -> defaultIssue[] },
                 ],
                ],
                [action    : 'getIssueHistoryList', ext: ": Chack :" + it,
                 sleep     : sleep,
                 parameters: [
                         issue     : { -> defaultIssue[] },
                         outputType: "Text",
                         select    : ["Field:summary","To String:$it"],
                         columns   : "Author,'To String'",
                 ],
                 data      : ["$getCurrentUserName", "$it"],
                ]
        ])
    }
}

if(!isCloud) {
    gint.taskHelper.add(
            action: 'assignIssue',
            sleep: sleep,
            parameters: [
                    issue   : { -> defaultIssue[] },
                    assignee: testUser
            ]
    )
}

[
        'runAsUserInFieldAssignee',
].each {
    if(!isCloud) {
        gint.taskHelper.add([
                [action    : 'transitionIssue', ext: " : " + it,
                 sleep     : sleep,
                 parameters: [
                         transition: it,
                         issue     : { -> defaultIssue[] },
                 ],
                ],
                [action    : 'getIssueHistoryList', ext: ": Chack :" + it,
                 sleep     : sleep,
                 parameters: [
                         issue     : { -> defaultIssue[] },
                         outputType: "Text",
                         select    : ["Field:summary","To String:$it"],
                         columns   : "Author,'To String'",
                 ],
                 data      : ["$testUser", "$it"],
                ]
        ])
    }
}