buildscript {
    repositories {
        maven {
            url "https://plugins.gradle.org/m2/"
        }
    }
    dependencies {
        classpath "org.gint:gint-atlassian:3.8.4"
    }
}

apply plugin: 'org.gint.atlassian'
//apply from: gint.resourceDirectory +'/src/common/utils.gradle'
apply from: gint.resourceDirectory +'/src/itest-postfunction1/postfunction1.gradle'

def field = [
        storyPoint : [ "field=$storyPointFieldId" ],
        originalStoryPoint : ["field=$originalStoryPointsFieldId"]
]

def functionKey = info?.isCloud ? 'com.atlassian.plugins.atlassian-connect-plugin:com.innovalog.jmwe.jira-misc-workflow-extensions__IncreaseFieldValueFunction' : 'com.innovalog.jmwe.jira-misc-workflow-extensions:IncreaseFieldValue-function'

def defaultFieldsCloud = [
        "postFunction.id=18b36491-f556-48cd-b476-7b82f02c7249"
]

['increaseValueOfStoryPoint'].each {
    def server = defaultFieldsServer + field.storyPoint + conditionalExecution.false
    def cloud = defaultFieldsCloud + "postFunction.config-18b36491-f556-48cd-b476-7b82f02c7249={\"conditionalExecution\":false,\"sendNotifications\":true,\"fieldId\":\"$storyPointFieldId\"}"
    addTransitionFunction(it, 'postfunction', info?.isCloud ? cloud : server, functionKey )
}

[
        'increaseValueOfOriginalStoryPoint'
].each {
    def server = defaultFieldsServer +  field.originalStoryPoint + conditionalExecution.false
    if(!isCloud){
        addTransitionFunction(it , 'postfunction', server, functionKey )
    }
}

['increaseValueOfStoryPointIfConditionTrue'].each {
    def server = defaultFieldsServer + field.storyPoint + conditionalExecution.true
    def cloud = defaultFieldsCloud + "postFunction.config-18b36491-f556-48cd-b476-7b82f02c7249={\"conditionalExecution\":true,\"conditionalExecutionScript\":\"$nunjuckExpression.checkPriorityHigh\",\"sendNotifications\":true,\"fieldId\":\"$storyPointFieldId\"}"
    addTransitionFunction(it, 'postfunction', info?.isCloud ? cloud : server, functionKey )
}

['increaseValueOfOriginalStoryPointIfConditionTrue'].each {
    def server = defaultFieldsServer +  field.originalStoryPoint + conditionalExecution.true
    if(!isCloud){
        addTransitionFunction(it , 'postfunction', server, functionKey )
    }
}

createWorkflowScheme()
createProject()


def defaultIssue = createIssue([type: 'Story', summary: 'JMWE_Issue'], 'defaultIssue')

// checking the current status To Do and previous status In Progress
['increaseValueOfStoryPoint',].each {
    gint.taskHelper.add([
            [action    : 'transitionIssue',
             ext: " : " + it,
             sleep: info?.isCloud ? 5000 : 0,
             parameters: [
                     transition: it,
                     issue     : { -> defaultIssue[] },
             ],
            ],
            [action: 'getFieldValue',
             ext: ": Chack :" + it,
             sleep: info?.isCloud ? 5000 : 0,
             parameters: [
                     issue: {-> defaultIssue[]},
                     field : info?.isCloud ? "Story point estimate" : "Story Points",
             ],
             data:[ info?.isCloud ? "Story point estimate  . . . . : 1.0" : "Story Points  . . . . . . . . : 1.0" ],
            ]

    ])
}

['increaseValueOfOriginalStoryPoint',].each {
    if(!isCloud) {
        gint.taskHelper.add([
                [action    : 'transitionIssue', ext: " : " + it,
                 parameters: [
                         transition: it,
                         issue     : { -> defaultIssue[] },
                 ],
                ],
                [action    : 'getFieldValue', ext: ": : " + it,
                 parameters: [
                         issue: { -> defaultIssue[] },
                         field: "Original story points",
                 ],
                 data      : ["Original story points . . . . : 1.0"],
                ]
        ])
    }
}
['increaseValueOfStoryPointIfConditionTrue'].each {
    gint.taskHelper.add([
            [action    : 'transitionIssue',
             ext: " :  " + it,
             sleep: info?.isCloud ? 5000 : 0,
             parameters: [
                     transition: it,
                     issue     : { -> defaultIssue[] },
             ],
            ],
            [action: 'getFieldValue',
             ext: ": " + it,
             sleep: info?.isCloud ? 5000 : 0,
             parameters: [
                     issue: {-> defaultIssue[]},
                     field : info?.isCloud ? "Story point estimate" : "Story Points",
             ],
                    data:[info?.isCloud ? "Story point estimate  . . . . : 1.0" : "Story Points  . . . . . . . . : 1.0" ],
                    failData : [info?.isCloud ? "Story point estimate  . . . . : 2.0" : "Story Points  . . . . . . . . : 2.0" ],
            ]
    ])
}
['increaseValueOfOriginalStoryPointIfConditionTrue'].each {
    if(!isCloud){
    gint.taskHelper.add([
            [action    : 'transitionIssue',
             ext: " :  " + it,
             sleep: info?.isCloud ? 5000 : 0,
             parameters: [
                     transition: it,
                     issue     : { -> defaultIssue[] },
             ],
            ],
            [action: 'getFieldValue',
             ext: ":  " + it,
             sleep: info?.isCloud ? 5000 : 0,
             parameters: [
                     issue: {-> defaultIssue[]},
                     field : "Original story points",
             ],
             data:[ "Original story points . . . . : 1.0" ],
             failData : ["Original story points . . . . : 2.0"]
            ]
    ])
        }
}
gint.taskHelper.add(
        action : 'updateIssue', ext: ': To check conditional execution true',
        parameters : [
                issue: {->defaultIssue[]},
                priority : 'High'
        ]
)
['increaseValueOfStoryPointIfConditionTrue'].each {
    gint.taskHelper.add([
            [action    : 'transitionIssue',
             ext: " :when condition true  " + it,
             sleep: info?.isCloud ? 5000 : 0,
             parameters: [
                     transition: it,
                     issue     : { -> defaultIssue[] },
             ],
            ],
            [action: 'getFieldValue',
             ext: ":when condition true " + it,
             sleep: info?.isCloud ? 5000 : 0,
             parameters: [
                     issue: {-> defaultIssue[]},
                     field : info?.isCloud ? "Story point estimate" : "Story Points",
             ],
             failData:[ info?.isCloud ? "Story point estimate  . . . . : 1.0" : "Story Points  . . . . . . . . : 1.0" ],
             data : [ info?.isCloud ? "Story point estimate  . . . . : 2.0" : "Story Points  . . . . . . . . : 2.0" ],
            ]
    ])
}
[
        'increaseValueOfOriginalStoryPointIfConditionTrue'
].each {
    if(!isCloud){
    gint.taskHelper.add([
            [action    : 'transitionIssue',
             ext: " : when condition true " + it,
             sleep: info?.isCloud ? 5000 : 0,
             parameters: [
                     transition: it,
                     issue     : { -> defaultIssue[] },
             ],
            ],
            [action: 'getFieldValue',
             ext: ": when condition true " + it,
             sleep: info?.isCloud ? 5000 : 0,
             parameters: [
                     issue: {-> defaultIssue[]},
                     field : "Original story points",
             ],
             data:[ "Original story points . . . . : 2.0" ],
             failData : ["Original story points . . . . : 1.0"]
            ]
    ])
        }
}



