buildscript {
    repositories {
        maven {
            url "https://plugins.gradle.org/m2/"
        }
    }
    dependencies {
        classpath "org.gint:gint-atlassian:3.8.4"
    }
}

apply plugin: 'org.gint.atlassian'
apply from: gint.resourceDirectory +'/src/common/utils.gradle'

tearDown()
//tearDownUsers()
addWorkflow()

def fieldsList = [
        labels : 'labels',
        fixVersions : 'fixVersions',
        affectsVersions : 'versions',
        components : 'components',
        assignee : 'assignee',
]
def defaultFields = [
        "correlationId=",
]
def functionKey = functionKey.addFieldValueToParentIssuePfServer

// Configuration for validator
['addFieldLabelToParentIssue'].each {
    def fields = defaultFields + "field=labels" + "useGroovyCondition=no"
    addTransitionFunction(it, 'postfunction', fields, functionKey )
}

['addToParentIssueIfConditionTrue'].each {
    def fields = defaultFields +  "field=labels" + "useGroovyCondition=yes" + "groovyExpression=$groovyExpression.checkPriorityHigh"
    addTransitionFunction(it , 'postfunction', fields, functionKey )
}

createWorkflowScheme()
createProject()


def defaultIssue = createIssue([type: 'Task', summary: 'JMWE_Issue'], 'defaultIssue')
def subtask = createIssue([type: 'Sub-task', summary: 'JMWE_Issue', parent: {->defaultIssue[]}, labels: 'test_label'], 'subtask')
def defaultIssue1 = createIssue([type: 'Story', summary: 'JMWE_Issue', priority: 'High'], 'defaultIssue1')
def subtask1 = createIssue([type: 'Sub-task', summary: 'JMWE_Issue', parent: {->defaultIssue1[]},labels: 'test_label',priority: 'High'], 'subtask1')

// checking the current status To Do and previous status In Progress
['addToParentIssueIfConditionTrue',].each {
    gint.taskHelper.add([
            [action    : 'transitionIssue', ext: " :  when condition false ",
             parameters: [
                     transition: it,
                     issue     : { -> subtask[] },
             ],
            ],
            [action: 'getFieldValue', ext: ": Chack field value not added to parent issue as condition false",
             parameters: [
                     issue: {-> defaultIssue[]},
                     field : "Labels",
             ],
             failData:[ "Labels  . . . . . . . . . . . : test_label" ]
            ]

    ])
}

['addFieldLabelToParentIssue',].each {
        gint.taskHelper.add([
                [action    : 'transitionIssue', ext: " :  labels "+ it,
                 parameters: [
                         transition: it,
                         issue     : { -> subtask[] },
                 ],
                ],
                [action: 'getFieldValue', ext: ": Chack field value should be added to parent issue",
                 parameters: [
                         issue: {-> defaultIssue[]},
                         field : "Labels",
                 ],
                 data:[
                         "Labels  . . . . . . . . . . . : test_label",
                 ]
                ]

        ])
}
['addToParentIssueIfConditionTrue',].each {
    gint.taskHelper.add([
            [action    : 'transitionIssue', ext: " :  when condition true ",
             parameters: [
                     transition: it,
                     issue     : { -> subtask1[] },
             ],
            ],
            [action: 'getFieldValue', ext: ": Chack field value should be added to parent issue when condition is true",
             parameters: [
                     issue: {-> defaultIssue1[]},
                     field : "Labels",
             ],
             data:[ "Labels  . . . . . . . . . . . : test_label" ]
            ]
    ])
}
