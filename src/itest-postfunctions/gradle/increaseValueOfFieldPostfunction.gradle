buildscript {
    repositories {
        maven {
            url "https://plugins.gradle.org/m2/"
        }
    }
    dependencies {
        classpath "org.gint:gint-atlassian:3.8.4"
    }
}

apply plugin: 'org.gint.atlassian'
apply from: gint.resourceDirectory +'/src/common/utils.gradle'

def defaultFields = [
        "throwExceptions=false",
        "correlationId=",
]
def field = [
        storyPoint : [ "field=$customFields.storyPoints" ],
        originalStoryPoint : ["field=$customFields.originalStoryPoints"]
]

def functionKey = 'com.innovalog.jmwe.jira-misc-workflow-extensions:IncreaseFieldValue-function'

// Configuration for validator
['increaseValueOfStoryPoint'].each {
    def fields = defaultFields + field.storyPoint + conditionalExecution.false
    addTransitionFunction(it, 'postfunction', fields, functionKey )
}

['increaseValueOfOriginalStoryPoint'].each {
    def fields = defaultFields +  field.originalStoryPoint + conditionalExecution.false
    addTransitionFunction(it , 'postfunction', fields, functionKey )
}
['increaseValueOfStoryPointIfConditionTrue'].each {
    def fields = defaultFields + field.storyPoint + conditionalExecution.true
    addTransitionFunction(it, 'postfunction', fields, functionKey )
}

['increaseValueOfOriginalStoryPointIfConditionTrue'].each {
    def fields = defaultFields +  field.originalStoryPoint + conditionalExecution.true
    addTransitionFunction(it , 'postfunction', fields, functionKey )
}
createWorkflowScheme()
createProject()


def defaultIssue = createIssue([type: 'Task', summary: 'JMWE_Issue'], 'defaultIssue')

// checking the current status To Do and previous status In Progress
['increaseValueOfStoryPoint',].each {
    gint.taskHelper.add([
            [action    : 'transitionIssue', ext: " : " + it,
             parameters: [
                     transition: it,
                     issue     : { -> defaultIssue[] },
             ],
            ],
            [action: 'getFieldValue', ext: ": Chack :" + it,
             parameters: [
                     issue: {-> defaultIssue[]},
                     field : "Story Points",
             ],
             data:[ "Story Points  . . . . . . . . : 1.0" ],
            ]

    ])
}

['increaseValueOfOriginalStoryPoint',].each {
    gint.taskHelper.add([
            [action    : 'transitionIssue', ext: " : "+ it,
             parameters: [
                     transition: it,
                     issue     : { -> defaultIssue[] },
             ],
            ],
            [action: 'getFieldValue', ext: ": : " + it,
             parameters: [
                     issue: {-> defaultIssue[]},
                     field : "Original story points",
             ],
             data:[ "Original story points . . . . : 1.0"  ],
            ]

    ])
}
['increaseValueOfStoryPointIfConditionTrue'].each {
    gint.taskHelper.add([
            [action    : 'transitionIssue', ext: " :  " + it,
             parameters: [
                     transition: it,
                     issue     : { -> defaultIssue[] },
             ],
            ],
            [action: 'getFieldValue', ext: ": " + it,
             parameters: [
                     issue: {-> defaultIssue[]},
                     field : "Story Points",
             ],
                    data:[ "Story Points  . . . . . . . . : 1.0" ],
                    failData : ["Story Points  . . . . . . . . : 2.0"]
            ]
    ])
}
['increaseValueOfOriginalStoryPointIfConditionTrue'].each {
    gint.taskHelper.add([
            [action    : 'transitionIssue', ext: " :  " + it,
             parameters: [
                     transition: it,
                     issue     : { -> defaultIssue[] },
             ],
            ],
            [action: 'getFieldValue', ext: ":  " + it,
             parameters: [
                     issue: {-> defaultIssue[]},
                     field : "Original story points",
             ],
             data:[ "Original story points . . . . : 1.0" ],
             failData : ["Original story points . . . . : 2.0"]
            ]
    ])
}
gint.taskHelper.add(
        action : 'updateIssue', ext: ': To check conditional execution true',
        parameters : [
                issue: {->defaultIssue[]},
                priority : 'High'
        ]
)
['increaseValueOfStoryPointIfConditionTrue'].each {
    gint.taskHelper.add([
            [action    : 'transitionIssue', ext: " :when condition true  " + it,
             parameters: [
                     transition: it,
                     issue     : { -> defaultIssue[] },
             ],
            ],
            [action: 'getFieldValue', ext: ":when condition true " + it,
             parameters: [
                     issue: {-> defaultIssue[]},
                     field : "Story Points",
             ],
             data:[ "Story Points  . . . . . . . . : 2.0" ],
             failData : ["Story Points  . . . . . . . . : 1.0"]
            ]
    ])
}
['increaseValueOfOriginalStoryPointIfConditionTrue'].each {
    gint.taskHelper.add([
            [action    : 'transitionIssue', ext: " : when condition true " + it,
             parameters: [
                     transition: it,
                     issue     : { -> defaultIssue[] },
             ],
            ],
            [action: 'getFieldValue', ext: ": when condition true " + it,
             parameters: [
                     issue: {-> defaultIssue[]},
                     field : "Original story points",
             ],
             data:[ "Original story points . . . . : 2.0" ],
             failData : ["Original story points . . . . : 1.0"]
            ]
    ])
}



