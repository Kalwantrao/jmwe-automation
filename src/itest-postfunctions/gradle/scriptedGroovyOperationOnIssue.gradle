buildscript {
    repositories {
        maven {
            url "https://plugins.gradle.org/m2/"
        }
    }
    dependencies {
        classpath "org.gint:gint-atlassian:3.8.4"
    }
}

apply plugin: 'org.gint.atlassian'
apply from: gint.resourceDirectory +'/src/common/utils.gradle'

def script = [
        setLabels : [ "groovyExpression=issue.setFieldValue('Labels','test_label')","scriptDescription=" ],
        currentUser : [ "groovyExpression=issue.setFieldValue('Labels','runAsCurrentUser')","scriptDescription=" ],
        specificUser : [ "groovyExpression=issue.setFieldValue('Labels','runAsSpecificUser')","scriptDescription=" ],
        userInFieldAssignee : [ "groovyExpression=issue.setFieldValue('Labels','runAsUserInFieldAssignee')","scriptDescription=" ],
        userInFieldReporter : [ "groovyExpression=issue.setFieldValue('Labels','runAsUserInFieldReporter')","scriptDescription=" ],
        userInFieldCreator : [ "groovyExpression=issue.setFieldValue('Labels','runAsUserInFieldCreator')","scriptDescription=" ],
        userFromScript : [ "groovyExpression=issue.setFieldValue('Labels','runAsUserFromScript')","scriptDescription=" ],
]

def functionKey = info?.isCloud ? 'com.atlassian.plugins.atlassian-connect-plugin:com.innovalog.jmwe.jira-misc-workflow-extensions__ScriptedPostFunction' : 'com.innovalog.jmwe.jira-misc-workflow-extensions:groovy-function'

// Configuration

['setLabelByScript'].each {
    def fields = defaultFieldsServer + script.setLabels
    addTransitionFunction(it, 'postfunction', fields, functionKey )
}

['runAsCurrentUser'].each {
    def fields = defaultFieldsServer + script.currentUser + runAsUser.currentUser
    addTransitionFunction(it , 'postfunction', fields, functionKey )
    if(!isCloud) {
        moveTransitionFunction(it, 4)
    }
}
['runAsUserInFieldReporter'].each {
    def fields = defaultFieldsServer + script.userInFieldReporter + runAsUser.userInFieldReporter
    addTransitionFunction(it , 'postfunction', fields, functionKey )
    if(!isCloud) {
        moveTransitionFunction(it, 4)
    }
}
['runAsUserInFieldCreator'].each {
    def fields = defaultFieldsServer + script.userInFieldCreator + runAsUser.userInFieldCreator
    addTransitionFunction(it , 'postfunction', fields, functionKey )
    if(!isCloud) {
        moveTransitionFunction(it, 4)
    }
}

['runAsUserFromScript'].each {
    def fields = defaultFieldsServer + script.userFromScript + runAsUser.userFromScript
    addTransitionFunction(it, 'postfunction', fields, functionKey )
    if(!isCloud) {
        moveTransitionFunction(it, 4)
    }
}

['runAsUserInFieldAssignee'].each {
    def fields = defaultFieldsServer + script.userInFieldAssignee + runAsUser.userInFieldAssignee
    addTransitionFunction(it, 'postfunction', fields, functionKey )
    if(!isCloud) {
        moveTransitionFunction(it, 4)
    }
}
['runAsSpecificUser'].each {
    def fields = defaultFieldsServer + script.specificUser + runAsUser.specificUser
    addTransitionFunction(it, 'postfunction', fields, functionKey )
    if(!isCloud) {
        moveTransitionFunction(it, 4)
    }
}

createWorkflowScheme()
createProject()


def defaultIssue = createIssue([type: 'Task', summary: 'JMWE_Issue'], 'defaultIssue')

// checking the current status To Do and previous status In Progress
[
        'setLabelByScript'
].each {
    gint.taskHelper.add([
            [action    : 'transitionIssue', ext: " : " + it,
             sleep: info?.isCloud ? 5000 : 0,
             parameters: [
                     transition: it,
                     issue     : { -> defaultIssue[] },
             ],
            ],
            [action: 'getFieldValue', ext: ": Chack :" + it,
             sleep: info?.isCloud ? 5000 : 0,
             parameters: [
                     issue: {-> defaultIssue[]},
                     field : "Labels",
             ],
             data:[ "Labels  . . . . . . . . . . . : test_label" ],
            ]

    ])
}

[
        'runAsCurrentUser',
        'runAsUserInFieldReporter',
        'runAsUserInFieldCreator',
        'runAsUserFromScript'
].each {
        gint.taskHelper.add([
                [action    : 'transitionIssue', ext: " : " + it ,
                 sleep: info?.isCloud ? 5000 : 0,
                 parameters: [
                         transition: it ,
                         issue     : { -> defaultIssue[] },
                 ],
                ],
                [action    : 'getIssueHistoryList', ext: ": Chack :" + it ,
                 sleep: info?.isCloud ? 5000 : 0,
                 parameters: [
                         issue: { -> defaultIssue[] },
                         outputType: "Text",
                         select: "Field:labels",
                         columns : "Author,'To String'",
                 ],
                 data      : ["$user","$it"],
                ]

        ])
}

gint.taskHelper.add(
        action: 'assignIssue',
        sleep: info?.isCloud ? 5000 : 0,
        parameters:[
                issue: {->defaultIssue[]},
                assignee: testUser
        ]
)

[
        'runAsUserInFieldAssignee',
        'runAsSpecificUser',
].each {
    gint.taskHelper.add([
            [action    : 'transitionIssue', ext: " : " + it ,
             sleep: info?.isCloud ? 5000 : 0,
             parameters: [
                     transition: it ,
                     issue     : { -> defaultIssue[] },
             ],
            ],
            [action    : 'getIssueHistoryList', ext: ": Chack :" + it ,
             sleep: info?.isCloud ? 5000 : 0,
             parameters: [
                     issue: { -> defaultIssue[] },
                     outputType: "Text",
                     select: "Field:labels",
                     columns : "Author,'To String'",
             ],
             data      : ["$testUser","$it"],
            ]
    ])
}