buildscript {
	repositories {
		maven {
			url "https://plugins.gradle.org/m2/"
		}
	}
	dependencies {
		classpath "org.gint:gint-atlassian:3.8.4"
	}
}

apply plugin: 'org.gint.atlassian'
apply from: gint.resourceDirectory +'/src/common/utils.gradle'

def functionKey = info?.isCloud? 'com.atlassian.plugins.atlassian-connect-plugin:com.innovalog.jmwe.jira-misc-workflow-extensions__UserCondition' : 'com.innovalog.jmwe.jira-misc-workflow-extensions:generic-user-condition'

def defaultFieldsCloud = [ "condition.id=85e260ad-0ccf-433d-bd76-2fcda1e4bb6d" ]

def whichUser = [
		currentUser : ["fromUserType=currentUser"],
		userInFieldAssignee : [ "fromUserType=userInField", "userField=assignee" ],
		userInFieldReporter : [  "fromUserType=userInField", "userField=reporter"],
		userInFieldCreator : [  "fromUserType=userInField", "userField=creator"],
]

def userMode = [
		allUsers : [ "conditionMode=all-user-condition" ],
		atLeastOne : [ "conditionMode=any-user-condition" ],
]

def fieldEmpty = [
		no : [ "fieldEmpty=no" ],
		yes : [ "fieldEmpty=yes" ],
]

def userCriteria = [
		reporter : "isReporter=yes",
		assignee : "isAssignee=yes",
		inFieldAssignee : "userFieldsToCheck=assignee",
		returnFromScript : /usersConditionScript=issue.get('reporter')?.name == "$user"/,
		projectLead : "isProjectLead=yes",
		inAdminRole : "rolesToCheck=$jiraAdminRoleId",
		inAdminGroup : "groupsToCheck=jira-administrators",
		inTestGroup : "groupsToCheck=$testGroup",
		watcher : "isWatcher=yes",
		checkUser : "usersToCheck=$currentUserKey",
]

def reverse = [
		no : [ "reverse=" ],
		yes : [ "reverse=yes" ]
]

def currentUserConditionCriteria = info?.isCloud ? currentUserConditionCriteriaCloud : userCriteria
def userInFieldAssigneeUserConditionCriteria = info?.isCloud ? userInFieldAssigneeUserConditionCriteriaCloud : userCriteria
def userInFieldReporterUserConditionCriteria = info?.isCloud ? userInFieldReporterUserConditionCriteriaCloud : userCriteria
def userInFieldCreatorUserConditionCriteria = info?.isCloud ? userInFieldCreatorUserConditionCriteriaCloud : userCriteria

currentUserConditionCriteria.eachWithIndex { criteria, userFields, i ->
	def transition = "verify_current_user_should_be_" + criteria
	def cloud = defaultFieldsCloud + "condition.config-85e260ad-0ccf-433d-bd76-2fcda1e4bb6d=$userFields"
	def server = defaultFieldsServer + userFields +  whichUser.currentUser + reverse.no + userMode.allUsers + fieldEmpty.no
	addTransitionFunction(transition, 'condition', info?.isCloud ? cloud : server, functionKey )
}

userInFieldAssigneeUserConditionCriteria.eachWithIndex { criteria, userFields, i ->
	def transition = "verify_user_in_field_assignee_should_be_" + criteria
	def cloud = defaultFieldsCloud + "condition.config-85e260ad-0ccf-433d-bd76-2fcda1e4bb6d=$userFields"
	def server = defaultFieldsServer + userFields + whichUser.userInFieldAssignee + reverse.no + userMode.allUsers + fieldEmpty.no
	addTransitionFunction(transition, 'condition', info?.isCloud ? cloud : server,  functionKey )
}

userInFieldReporterUserConditionCriteria.eachWithIndex { criteria, userFields, i ->
	def transition = "verify_user_in_field_reporter_should_be_" + criteria
	def cloud = defaultFieldsCloud + "condition.config-85e260ad-0ccf-433d-bd76-2fcda1e4bb6d=$userFields"
	def server = defaultFieldsServer + whichUser.userInFieldReporter + userFields + reverse.no + userMode.allUsers + fieldEmpty.no
	addTransitionFunction(transition, 'condition', info?.isCloud ? cloud : server, functionKey )
}

userInFieldCreatorUserConditionCriteria.eachWithIndex { criteria, userFields, i ->
	def transition = "verify_user_in_field_creator_should_be_" + criteria
	def cloud = defaultFieldsCloud + "condition.config-85e260ad-0ccf-433d-bd76-2fcda1e4bb6d=$userFields"
	def server = defaultFieldsServer + whichUser.userInFieldCreator + userFields + reverse.no + userMode.allUsers + fieldEmpty.no
	addTransitionFunction(transition, 'condition', info?.isCloud ? cloud : server, functionKey )
}

['verify_current_user_should_be_in_assignee_reporter'].each {
	def server =  defaultFieldsServer + whichUser.currentUser + userCriteria.assignee + userCriteria.reporter + reverse.no + userMode.allUsers + fieldEmpty.no
	def cloud = defaultFieldsCloud + "condition.config-85e260ad-0ccf-433d-bd76-2fcda1e4bb6d={\"problems\":[],\"fromUserType\":\"currentUser\",\"conditionMode\":\"all-user-condition\",\"userCriteria\":{\"isReporter\":true,\"isAssignee\":true},\"expression\":\"let selectedUser = user; ((!!user && (false || (!!issue.reporter && user.accountId == issue.reporter.accountId)&&(!!issue.assignee && user.accountId == issue.assignee.accountId))))\"}"
	addTransitionFunction(it, 'condition', info?.isCloud ? cloud : server, functionKey)
}

['verify_current_user_should_be_in_at_least_one_field_assignee_reporter'].each {
	def server =  defaultFieldsServer + whichUser.currentUser + userCriteria.assignee + userCriteria.reporter + reverse.no + userMode.atLeastOne + fieldEmpty.no
	def cloud = defaultFieldsCloud + "condition.config-85e260ad-0ccf-433d-bd76-2fcda1e4bb6d={\"problems\":[],\"fromUserType\":\"currentUser\",\"conditionMode\":\"any-user-condition\",\"userCriteria\":{\"isReporter\":true,\"isAssignee\":true},\"expression\":\"let selectedUser = user; ((!!user && (false || (!!issue.reporter && user.accountId == issue.reporter.accountId)||(!!issue.assignee && user.accountId == issue.assignee.accountId))))\"}"
	addTransitionFunction(it, 'condition', info?.isCloud ? cloud : server, functionKey)}

['verify_user_in_field_creator_should_be_in_at_least_one_field_reporter_assignee'].each {
	def server =  defaultFieldsServer + whichUser.userInFieldCreator + userCriteria.inFieldAssignee + userCriteria.reporter + reverse.no + userMode.atLeastOne + fieldEmpty.no
	def cloud = defaultFieldsCloud + "condition.config-85e260ad-0ccf-433d-bd76-2fcda1e4bb6d={\"problems\":[],\"userField\":\"creator\",\"fromUserType\":\"userInField\",\"fieldEmpty\":false,\"conditionMode\":\"any-user-condition\",\"userCriteria\":{\"isReporter\":true,\"isAssignee\":true},\"expression\":\"let selectedUser = !!issue && !!issue.creator && issue.creator; ((!!issue && !!issue.creator && (false || (!!issue.reporter && issue.creator.accountId == issue.reporter.accountId)||(!!issue.assignee && issue.creator.accountId == issue.assignee.accountId))))\"}"
	addTransitionFunction(it, 'condition', info?.isCloud ? cloud : server, functionKey)}

['currentUser_should_not_be_in_fields_assignee_reporter_reverse'].each {
	def server =  defaultFieldsServer + whichUser.currentUser + userCriteria.assignee + userCriteria.reporter + reverse.yes + userMode.atLeastOne + fieldEmpty.no
	def cloud = defaultFieldsCloud + "condition.config-85e260ad-0ccf-433d-bd76-2fcda1e4bb6d={\"problems\":[],\"fromUserType\":\"currentUser\",\"conditionMode\":\"all-user-condition\",\"userCriteria\":{\"isReporter\":true,\"isAssignee\":true,\"reverse\":true},\"expression\":\"let selectedUser = user; !((!!user && (false || (!!issue.reporter && user.accountId == issue.reporter.accountId)&&(!!issue.assignee && user.accountId == issue.assignee.accountId))))\"}"
	addTransitionFunction(it, 'condition', info?.isCloud ? cloud : server, functionKey)}

['user_in_field_reporter_should_be_in_field_assignee_or_field_empty'].each {
	def server =  defaultFieldsServer + whichUser.userInFieldReporter + userCriteria.inFieldAssignee + reverse.no + userMode.atLeastOne + fieldEmpty.yes
	def cloud = defaultFieldsCloud + "condition.config-85e260ad-0ccf-433d-bd76-2fcda1e4bb6d={\"problems\":[],\"userField\":\"reporter\",\"fromUserType\":\"userInField\",\"fieldEmpty\":true,\"conditionMode\":\"any-user-condition\",\"userCriteria\":{\"isAssignee\":true},\"expression\":\"let selectedUser = !!issue && issue.reporter; ((!!issue && (!issue.reporter || (!!issue.assignee && issue.reporter.accountId == issue.assignee.accountId))))\"}"
	addTransitionFunction(it, 'condition', info?.isCloud ? cloud : server, functionKey)}

createWorkflowScheme()
createProject()

def defaultIssue = createIssue([type: 'Task', summary: 'JMWE_Issue'], 'defaultIssue')
def currentUser = info?.isCloud ? info?.userDisplayName : user

// USER_CONDITION_TS_26_TC_01_Verify the current user should be reporter
[
		'verify_current_user_should_be_reporter',
		'verify_current_user_should_be_assignee',
		'verify_current_user_should_be_inFieldAssignee',
		'verify_current_user_should_be_returnFromScript',
].each {
	def fieldToCheck ;
	if(it == 'verify_current_user_should_be_reporter'){
		fieldToCheck = "Reporter"
	}
	else if(it == 'verify_current_user_should_be_assignee'){
		fieldToCheck = "Assignee"
	}
	else if(it == 'verify_current_user_should_be_inFieldAssignee'){
		fieldToCheck = "Assignee"
	}
	else if(it == 'verify_current_user_should_be_returnFromScript'){
		fieldToCheck = "Reporter"
	}
		gint.taskHelper.add([
				[action    : 'setFieldValue',
				 sleep: info?.isCloud ? 5000 : 0,
				 ext: ":Of field_ $fieldToCheck to $currentUser _to check_ $it: ",
				 parameters: [
						 issue     : {->defaultIssue[]},
						 field: fieldToCheck,
						 value: user,
				 ],
				],
				[action      : 'getFieldValue',
				 sleep: info?.isCloud ? 5000 : 0,
				 ext: ":Validate that the current user should be in $fieldToCheck _ to check:$it ",
				 parameters: [
			        issue: {-> defaultIssue[] },
					field: fieldToCheck
				 ],
				 finalClosure: { Task task ->
					def getUserInField = "$task.outData"
					 assert getUserInField.contains(currentUser)
				 }
				],
			[action    : 'transitionIssue',
			 sleep: info?.isCloud ? 5000 : 1000,
			 ext: ":USER_CONDITION_TS_26_TC_01_Case_01_ $it _when current user is in field_ $fieldToCheck: ",
			 expected  : 0,
			 parameters: [
					 issue     : {->defaultIssue[]},
					 transition: it,
			 ],
			],
			[action    : 'setFieldValue',
			 sleep: info?.isCloud ? 5000 : 1000,
			 ext: ":Of field_ $fieldToCheck to $testUser _to check_ $it _when current user is not in field_ $it: ",
			 parameters: [
					 issue     : {->defaultIssue[]},
					 field: fieldToCheck,
					 value: testUser,
			 ],
			],
			[action    : 'transitionIssue',
			 sleep: info?.isCloud ? 5000 : 1000,
			 ext: ":USER_CONDITION_TS_26_TC_01_Case_02_ $it _when current user is not in field _ $fieldToCheck: ",
			 expected  : -1,
			 parameters: [
					 issue     : {->defaultIssue[]},
					 transition: it,
			 ],
			],
	])
}

// USER_CONDITION_TS_30_TC_05_Verify the current user should be project lead
def projectLeadList = [ testUser, currentUser ]

[
		'verify_current_user_should_be_projectLead',
		'verify_user_in_field_assignee_should_be_projectLead',
		'verify_user_in_field_reporter_should_be_projectLead',
		'verify_user_in_field_creator_should_be_projectLead',

].eachWithIndex { String transition, int i ->
	projectLeadList.eachWithIndex { usersToCheck, idx ->
		def expected;
		if(usersToCheck == testUser){
			expected = -1
		}
		else if(usersToCheck == currentUser){
			expected = 0
		}
		def fieldToCheck;
			if(transition == 'verify_user_in_field_assignee_should_be_projectLead'){
				fieldToCheck = "Assignee"
			}
		else if (transition == 'verify_user_in_field_reporter_should_be_projectLead'){
				fieldToCheck = "Reporter"
		}
		else { fieldToCheck = "Assignee" }
		if(!isCloud) {
			gint.taskHelper.add([
					[action    : 'setFieldValue',
					 sleep     : info?.isCloud ? 5000 : 1000,
					 ext       : ":Of field_ $fieldToCheck _ to $currentUser _when the user_ $usersToCheck _is project lead:$transition  ",
					 parameters: [
							 issue: { -> defaultIssue[] },
							 field: fieldToCheck,
							 value: currentUser
					 ],
					],
					[action    : 'updateProject',
					 ext       : ":change the project lead to $usersToCheck _to $transition : ",
					 parameters: [
							 project: projectName,
							 lead   : usersToCheck,
					 ],
					],
					[action      : 'transitionIssue',
					 ext         : ":USER_CONDITION_TS_3$idx _Case_01_ $transition _when project lead is $usersToCheck and field _ $fieldToCheck is $currentUser : ",
					 expected    : expected,
					 parameters  : [
							 issue     : { -> defaultIssue[] },
							 transition: transition,
					 ],
					 finalClosure: { Task task ->
						 if (task.result != expected) {
							 gint.helper.log("Check the project lead should be", usersToCheck)
						 }
						 assert task.result == expected
					 }
					],
			])
		}
		}
}

// USER_CONDITION_TS_40_TC_01_Verify the user in field assignee should be reporter
[
		'verify_user_in_field_assignee_should_be_reporter',
		//'verify_user_in_field_assignee_should_be_returnFromScript',
].each {
	def fieldToCheck;
	if(it == 'verify_user_in_field_assignee_should_be_reporter'){
		fieldToCheck = "Reporter"
	}
	else if (it == 'verify_user_in_field_assignee_should_be_returnFromScript'){
		fieldToCheck = "Reporter"
	}
	gint.taskHelper.add([
			[action    : 'setFieldValue',
			 sleep : info?.isCloud? 5000 : 0,
			 ext: ":assign to $testUser _ $it _to check criteria: ",
			 expected  : 0,
			 parameters: [
					 issue     : {->defaultIssue[]},
					 field: "Assignee",
					 value: testUser
			 ],
			],
			[action    : 'setFieldValue',
			 sleep : info?.isCloud? 5000 : 0,
			 ext: ":Of field_ $fieldToCheck _ to $testUser _ $it _when the user in field assignee is in field _ $fieldToCheck: ",
			 parameters: [
					 issue     : {->defaultIssue[]},
					 field: fieldToCheck,
					 value: testUser
			 ],
			],
			[action    : 'transitionIssue',
			 sleep : info?.isCloud? 5000 : 0,
			 ext: ":USER_CONDITION_TS_40_TC_01_Case_01_ $it _when  not satisfies the criteria: ",
			 expected  : 0,
			 parameters: [
					 issue     : {->defaultIssue[]},
					 transition: it,
			 ],
			 finalClosure: {Task task ->
				 if(task.result != 0){
					 gint.helper.log("Check user in field assignee in field", fieldToCheck)
					 assert task.result == 0
				 }
			 }
			],
			[action    : 'setFieldValue',
			 sleep : info?.isCloud? 5000 : 0,
			 ext: ":Of field_ $fieldToCheck to $user _ $it _to check criteria: ",
			 parameters: [
					 issue     : {->defaultIssue[]},
					 field: fieldToCheck,
					 value: user
			 ],
			],
			[action    : 'transitionIssue',
			 sleep : info?.isCloud? 5000 : 0,
			 ext: ":USER_CONDITION_TS_40_TC_01_Case_02_ $it _when the user in field assignee is not in field _ $fieldToCheck: ",
			 expected  : -1,
			 parameters: [
					 issue     : {->defaultIssue[]},
					 transition: it,
			 ],
			 finalClosure: {Task task ->
				 if(task.result != -1){
					 gint.helper.log("Check user in field assignee in field", fieldToCheck)
					 assert task.result == -1
				 }
			 }
			],
	])
}

// USER_CONDITION_TS_40_TC_05_Verify the user in field assignee should be of admin role
def adminUsersList = [ testUser, currentUser ]

[
		'verify_user_in_field_assignee_should_be_inAdminRole',
		'verify_user_in_field_reporter_should_be_inAdminRole',
		//'verify_user_in_field_creator_should_be_inAdminRole',
].eachWithIndex { transition, index ->
	adminUsersList.collect {
		def expected;
		if(it == testUser){
			expected = -1
		}
		else if(it == currentUser){
			expected = 0
		}
		def fieldToCheck;
		if (transition == 'verify_user_in_field_assignee_should_be_inAdminRole') {
			fieldToCheck = "Assignee"
		} else if (transition == 'verify_user_in_field_reporter_should_be_inAdminRole') {
			fieldToCheck = "Reporter"
		}
		gint.taskHelper.add([
				[action    : 'setFieldValue',
				 sleep : info?.isCloud? 5000 : 0,
				 ext       : ": Of Field $fieldToCheck to $it _to check _ $transition : ",
				 parameters: [
						 issue: { -> defaultIssue[] },
						 field: fieldToCheck,
						 value: it
				 ],],
				[action    : 'transitionIssue',
				 sleep : info?.isCloud? 5000 : 0,
				 ext       : ":USER_CONDITION_TS_40_TC_05_Case_01_ $transition _user in field_ $fieldToCheck is $it not in admin role: ",
				 expected  : expected,
				 parameters: [
						 issue     : { -> defaultIssue[] },
						 transition: transition,
				 ],
				],
		])
	}
}

// USER_CONDITION_TS_40_TC_07_Verify the user in field assignee should specific user_checkUser
// USER_CONDITION_TS_40_TC_14_Verify the user in field reporter should be specific user_checkUser

[
		'verify_user_in_field_assignee_should_be_checkUser',
		'verify_user_in_field_reporter_should_be_checkUser'
].eachWithIndex {transition, index ->
	def fieldToCheck;
	if(transition == 'verify_user_in_field_assignee_should_be_checkUser'){
		fieldToCheck = "Assignee"
	}
	else if( transition == 'verify_user_in_field_reporter_should_be_checkUser'){
		fieldToCheck = "Reporter"
	}
	adminUsersList.collect{
		def expected;
		if(it == currentUser){
			expected = 0
		}
		else {
			expected = -1
		}
		gint.taskHelper.add([
				[action    : 'setFieldValue',
				 ext: ": Of $fieldToCheck to $it _to check $transition : ",
				 sleep : info?.isCloud? 5000 : 0,
				 parameters: [
						 issue     : { ->defaultIssue[] },
						 field: fieldToCheck,
						 value: it
				 ],
				],
				[action    : 'getFieldValue',
				 sleep : info?.isCloud? 5000 : 0,
				 ext: ": Of $fieldToCheck should be_ $it _to check $transition : ",
				 parameters: [
						 issue     : { ->defaultIssue[] },
						 field: fieldToCheck,
				 ],
						finalClosure: {Task task ->
							assert "$task.outData".contains(it)
						}
				],
				[action    : 'transitionIssue',
				 sleep : info?.isCloud? 5000 : 0,
				 ext: ":USER_CONDITION_TS_40_TC_07_Case_01_ $transition _when current user _ $it _ in field $fieldToCheck: ",
				 expected  : expected,
				 parameters: [
						 issue     : {->defaultIssue[]},
						 transition: transition,
				 ],
				 finalClosure: {Task task ->
					 assert task.result == expected
				 }
				],
		])

	}
}

// USER_CONDITION_TS_40_TC_08_Verify the user in field reporter should be
[
		'verify_user_in_field_reporter_should_be_assignee',
		'verify_user_in_field_reporter_should_be_inFieldAssignee'
].eachWithIndex { transition, index ->
	adminUsersList.collect {
		def userInfieldReporter = currentUser
		def expected;
		if(it == currentUser){
			expected = 0
		}
		else {
			expected = -1
		}
		def fieldToCheck;
		if (transition == 'verify_user_in_field_reporter_should_be_assignee') {
			fieldToCheck = "Assignee"
		} else if (transition == 'verify_user_in_field_reporter_should_be_inFieldAssignee') {
			fieldToCheck = "Assignee"
		}
		gint.taskHelper.add([
				[action    : 'setFieldValue',
				 sleep : info?.isCloud? 5000 : 0,
				 ext       : ":Of field Reporter $userInfieldReporter _to check $transition _when the user in field_ $fieldToCheck is _$it: ",
				 parameters: [
						 issue: { -> defaultIssue[] },
						 field: "Reporter",
						 value: userInfieldReporter
				 ],
				],
				[action    : 'setFieldValue',
				 sleep : info?.isCloud? 5000 : 0,
				 ext       : ":Of field_ $fieldToCheck to $it _to check $transition _when user in field _ $fieldToCheck is _$it : ",
				 parameters: [
						 issue: { -> defaultIssue[] },
						 field: fieldToCheck,
						 value: it
				 ],
				],
				[action    : 'getFieldValue',
				 sleep : info?.isCloud? 5000 : 0,
				 ext: ": Of $fieldToCheck should be_ $it _to check $transition : ",
				 parameters: [
						 issue     : { ->defaultIssue[] },
						 field: fieldToCheck,
				 ],
				 finalClosure: {Task task ->
					 assert ("$task.outData").contains(it)
				 }
				],
				[action    : 'transitionIssue',
				 sleep : info?.isCloud? 5000 : 0,
				 ext       : ":USER_CONDITION_TS_40_TC_08_Case_01_ to check $transition _when user in field _ $fieldToCheck is _$it: ",
				 expected  : expected,
				 parameters: [
						 issue     : { -> defaultIssue[] },
						 transition: transition,
				 ],
				 finalClosure: {Task task ->
					 assert task.result == expected
				 }
				],
		])
	}
}

// USER_CONDITION_TS_40_TC_15_Verify the user in field creator should be reporter
[
		'verify_user_in_field_creator_should_be_reporter',
		'verify_user_in_field_creator_should_be_assignee',
		'verify_user_in_field_creator_should_be_inFieldAssignee'
].eachWithIndex { transition, index ->
	adminUsersList.collect {
		def userInFieldCreator = currentUser
		def fieldToCheck;
		if(transition == 'verify_user_in_field_creator_should_be_reporter'){
			fieldToCheck = "Reporter"
		}
		else if(transition == 'verify_user_in_field_creator_should_be_assignee'){
			fieldToCheck = "Assignee"
		}
		else if(transition == 'verify_user_in_field_creator_should_be_inFieldAssignee'){
			fieldToCheck = "Assignee"
		}
		def expected;
		if(it == currentUser){
			expected = 0
		}
		else {
			expected = -1
		}
		gint.taskHelper.add([
				[action    : 'setFieldValue',
				 sleep : info?.isCloud? 5000 : 0,
				 ext       : ":Of field _$fieldToCheck to $it _ to check $transition _when user in field creator is $userInFieldCreator and the user in field $fieldToCheck is $it: ",
				 parameters: [
						 issue: { -> defaultIssue[] },
						 field: fieldToCheck,
						 value: it
				 ],
				],
				[action    : 'getFieldValue',
				 sleep : info?.isCloud? 5000 : 0,
				 ext: ": Of $fieldToCheck should be_ $it _to check $transition : ",
				 parameters: [
						 issue     : { ->defaultIssue[] },
						 field: fieldToCheck,
				 ],
				 finalClosure: {Task task ->
					 assert ("$task.outData").contains(it)
				 }
				],
				[action    : 'transitionIssue',
				 sleep : info?.isCloud? 5000 : 0,
				 ext       : ":USER_CONDITION_TS_40_TC_15_Case_01_ $transition _when user in field creator is $userInFieldCreator and the user in field $fieldToCheck is $it: ",
				 expected  : expected,
				 parameters: [
						 issue     : { -> defaultIssue[] },
						 transition: transition,
				 ],
				 finalClosure: {Task task ->
					 assert task.result == expected
				 }
				],
		])
	}
}

// USER_CONDITION_TS_49_TC_01_Verify the mode: all the criteria configured below_current user
[
		'verify_current_user_should_be_in_assignee_reporter'
].each {
	adminUsersList.eachWithIndex { userToCheck, index ->
		def currentUserName = info?.isCloud? info?.userDisplayName : user
		def expected;
		if(userToCheck == currentUserName) {
			expected = 0
		}
		else { expected = -1 }

		["Assignee","Reporter"].eachWithIndex { fieldToCheck, idx ->
			gint.taskHelper.add([
					[action    : 'setFieldValue',
					 sleep     : info?.isCloud ? 5000 : 0,
					 ext       : ":Of field $fieldToCheck _to_ $userToCheck _to check_ $it : ",
					 parameters: [
							 issue: { -> defaultIssue[] },
							 field: fieldToCheck,
							 value: userToCheck
					 ],
					],
					[action      : 'getFieldValue',
					 sleep       : info?.isCloud ? 5000 : 0,
					 ext         : ":Of field $fieldToCheck _to_ $userToCheck _to check_ $it : ",
					 parameters  : [
							 issue: { -> defaultIssue[] },
							 field: fieldToCheck,
					 ],
					 finalClosure: { Task task ->
						 assert ("$task.outData").contains(userToCheck)
					 }
					],
			]
			)
		}
			gint.taskHelper.add([
					[action      : 'transitionIssue',
					 sleep : info?.isCloud? 5000 : 0,
					 ext         : ":USER_CONDITION_TS_49_TC_01_Case_01_ $it _when current user is_$currentUser _and user in fields_ assignee and reporter is_ $userToCheck: ",
					 expected    : expected,
					 parameters  : [
							 issue     : { -> defaultIssue[] },
							 transition: it,
					 ],
					 finalClosure: { Task task ->
						 assert task.result == expected
					 }
					],
			])
		}
}

// USER_CONDITION_TS_50_TC_01_Verify the mode: at least one of the criteria configured below_ current user
// USER_CONDITION_TS_50_TC_04_Verify the mode: at least one of the criteria configured below_ user in field creator

[
		//'verify_current_user_should_be_in_at_least_one_field_assignee_reporter',
		//'verify_user_in_field_creator_should_be_in_at_least_one_field_reporter_assignee'
].each {
	adminUsersList.eachWithIndex{ userToCheck, int idx ->
		["Assignee","Reporter"].eachWithIndex { fieldToCheck, int i ->
			def currentUserName = info?.isCloud? info?.userDisplayName : user
			def expected;
			if(userToCheck == currentUserName) {
				expected = 0
			}
			else {
				expected = -1
			}
			gint.taskHelper.add([
				[action    : 'setFieldValue',
				 sleep     : info?.isCloud ? 5000 : 0,
				 ext       : ":Of field _ $fieldToCheck set to $userToCheck _to check $it : ",
				 parameters: [
						 issue: { -> defaultIssue[] },
						 field: fieldToCheck,
						 value: userToCheck
				 ],
				],
				[action      : 'getFieldValue',
				 sleep       : info?.isCloud ? 5000 : 0,
				 ext         : ":Of field $fieldToCheck _to_ $userToCheck _to check_ $it : ",
				 parameters  : [
						 issue: { -> defaultIssue[] },
						 field: fieldToCheck,
				 ],
				 finalClosure: { Task task ->
					 assert ("$task.outData").contains(userToCheck)
				 }
				],
				[action    : 'transitionIssue',
				 sleep       : info?.isCloud ? 5000 : 0,
				 ext       : ":USER_CONDITION_TS_50_TC_01_Case_01_ $it _when current user is_ $currentUserName and user in field_ $fieldToCheck is $userToCheck: ",
				 expected  : expected,
				 parameters: [
						 issue     : { -> defaultIssue[] },
						 transition: it,
				 ],
				],
		])
	}
	}
}

// USER_CONDITION_TS_22_TC_04_Verify for the Reverse condition checkbox under the current user Condition configuration page
[
		'currentUser_should_not_be_in_fields_assignee_reporter_reverse'
].each {
	adminUsersList.eachWithIndex { userToCheck, index ->
		def currentUserName = info?.isCloud? info?.userDisplayName : user
		def expected;
		if(userToCheck == currentUserName) {
			expected = -1
		}
		else { expected = 0 }
		["Assignee","Reporter"].eachWithIndex { fieldToCheck, idx ->
			gint.taskHelper.add([
					[action    : 'setFieldValue',
					 sleep     : info?.isCloud ? 5000 : 0,
					 ext       : ":Of field $fieldToCheck _to_ $userToCheck _to check_ $it : ",
					 parameters: [
							 issue: { -> defaultIssue[] },
							 field: fieldToCheck,
							 value: userToCheck
					 ],
					],
					[action      : 'getFieldValue',
					 sleep       : info?.isCloud ? 5000 : 0,
					 ext         : ":Of field $fieldToCheck _to_ $userToCheck _to check_ $it : ",
					 parameters  : [
							 issue: { -> defaultIssue[] },
							 field: fieldToCheck,
					 ],
					 finalClosure: { Task task ->
						 assert ("$task.outData").contains(userToCheck)
					 }
					],
			]
			)
		}
		gint.taskHelper.add([
				[action      : 'transitionIssue',
				 sleep : info?.isCloud? 5000 : 0,
				 ext         : ":USER_CONDITION_TS_22_TC_01_Case_01_ $it _when current user is_$currentUser _and user in fields_ assignee and reporter is_ $userToCheck: ",
				 expected    : expected,
				 parameters  : [
						 issue     : { -> defaultIssue[] },
						 transition: it,
				 ],
				 finalClosure: { Task task ->
					 assert task.result == expected
				 }
				],
		])
	}
}

/*
// USER_CONDITION_TS_40_TC_09_Verify the user in field assignee should be in field labels

// USER_CONDITION_TS_40_TC_10_Verify the user in field reporter should be return from script
[
		'verify_user_in_field_reporter_should_be_returnFromScript',
].each {
	gint.taskHelper.add([
			[action    : 'setFieldValue',
			 ext: ":reporter value set to $testUser _to check $it : ",
			 expected  : 0,
			 parameters: [
					 issue     : {->defaultIssue[]},
					 field: "Reporter",
					 value: testUser
			 ],
			],
			[action    : 'transitionIssue',
			 ext: ":USER_CONDITION_TS_40_TC_10_Case_01_ $it _when not satisfies the criteria: ",
			 expected  : -1,
			 parameters: [
					 issue     : {->defaultIssue[]},
					 transition: it,
			 ],
			],
			[action    : 'setFieldValue',
			 ext: ":reporter value set to $user _to check $it : ",
			 expected  : 0,
			 parameters: [
					 issue     : {->defaultIssue[]},
					 field: "Reporter",
					 value: user
			 ],
			],
			[action    : 'transitionIssue',
			 ext: ":USER_CONDITION_TS_40_TC_10_Case_02_ $it _when satisfies the criteria: ",
			 expected  : 0,
			 parameters: [
					 issue     : {->defaultIssue[]},
					 transition: it,
			 ],
			],
	])
}

// USER_CONDITION_TS_40_TC_13_Verify the user in field reporter should be in admin group
[
		'verify_user_in_field_reporter_should_be_inAdminGroup',
].each {
	gint.taskHelper.add([
			[action    : 'setFieldValue',
			 ext: ": of reporter to $testUser _to check $it : ",
			 expected  : 0,
			 parameters: [
					 issue     : { ->defaultIssue[] },
					 field: "Reporter",
					 value: testUser
			 ],
			],
			[action    : 'transitionIssue',
			 ext: ":USER_CONDITION_TS_40_TC_13_Case_01_ $it _when not satisfies the criteria: ",
			 expected  : -1,
			 parameters: [
					 issue     : {->defaultIssue[]},
					 transition: it,
			 ],
			],
			[action    : 'setFieldValue',
			 ext: ": of reporter to $user _to check $it : ",
			 expected  : 0,
			 parameters: [
					 issue     : { ->defaultIssue[] },
					 field: "Reporter",
					 value: user
			 ],
			],
			[action    : 'transitionIssue',
			 ext: ":USER_CONDITION_TS_40_TC_13_Case_02_ $it _when satisfies the criteria: ",
			 expected  : 0,
			 parameters: [
					 issue     : {->defaultIssue[]},
					 transition: it,
			 ],
			],
	])
}


// USER_CONDITION_TS_40_TC_16_Verify the user in field creator should be assignee

// USER_CONDITION_TS_40_TC_17_Verify the user in field creator should be in field labels

// USER_CONDITION_TS_40_TC_18_Verify the user in field creator should be return from script
[
		'verify_user_in_field_creator_should_be_returnFromScript',
].each {
	gint.taskHelper.add([
			[action    : 'setFieldValue',
			 ext: ":reporter value set to $testUser _to check $it : ",
			 expected  : 0,
			 parameters: [
					 issue     : {->defaultIssue[]},
					 field: "Reporter",
					 value: testUser
			 ],
			],
			[action    : 'transitionIssue',
			 ext: ":USER_CONDITION_TS_40_TC_18_Case_01_ $it _when not satisfies the criteria: ",
			 expected  : -1,
			 parameters: [
					 issue     : {->defaultIssue[]},
					 transition: it,
			 ],
			],
			[action    : 'setFieldValue',
			 ext: ":reporter value set to $user _to check $it : ",
			 expected  : 0,
			 parameters: [
					 issue     : {->defaultIssue[]},
					 field: "Reporter",
					 value: user
			 ],
			],
			[action    : 'transitionIssue',
			 ext: ":USER_CONDITION_TS_40_TC_18_Case_02_ $it _when satisfies the criteria: ",
			 expected  : 0,
			 parameters: [
					 issue     : {->defaultIssue[]},
					 transition: it,
			 ],
			],
	])
}

// USER_CONDITION_TS_40_TC_19_Verify the user in field creator should be projectLead


// USER_CONDITION_TS_40_TC_20_Verify the user in field creator should be of admin role
[
		'verify_user_in_field_creator_should_be_inAdminRole',
].each {
	gint.taskHelper.add([
			[action    : 'transitionIssue',
			 ext: ":USER_CONDITION_TS_40_TC_20_Case_01_ $it _when not satisfies the criteria: ",
			 expected  : 0,
			 parameters: [
					 issue     : {->defaultIssue[]},
					 transition: it,
			 ],
			],
	])
}

// USER_CONDITION_TS_40_TC_21_Verify the user in field creator should be in admin group
[
		'verify_user_in_field_creator_should_be_inAdminGroup',
].each {
	gint.taskHelper.add([
			[action    : 'transitionIssue',
			 ext: ":USER_CONDITION_TS_40_TC_21_Case_01_ $it _when not satisfies the criteria: ",
			 expected  : 0,
			 parameters: [
					 issue     : {->defaultIssue[]},
					 transition: it,
			 ],
			],
	])
}

// USER_CONDITION_TS_40_TC_22_Verify the user in field creator should specific user_checkUser
[
		'verify_user_in_field_creator_should_be_checkUser',
].each {
	gint.taskHelper.add([
			[action    : 'transitionIssue',
			 ext: ":USER_CONDITION_TS_40_TC_22_Case_01_ $it _when not satisfies the criteria: ",
			 expected  : 0,
			 parameters: [
					 issue     : {->defaultIssue[]},
					 transition: it,
			 ],
			],
	])
}

// USER_CONDITION_TS_50_TC_01_Verify the mode: at least one of the criteria configured below_ current user
['verify_current_user_should_be_in_at_least_one_field_assignee_reporter'].each {
	if(!isCloud) {
		gint.taskHelper.add([
				[action    : 'setFieldValue',
				 ext       : ":assignee value set to $testUser _to check $it : ",
				 expected  : 0,
				 parameters: [
						 issue: { -> defaultIssue[] },
						 field: "Assignee",
						 value: testUser
				 ],
				],
				[action    : 'setFieldValue',
				 ext       : ":reporter value set to $testUser _to check $it : ",
				 expected  : 0,
				 parameters: [
						 issue: { -> defaultIssue[] },
						 field: "Reporter",
						 value: testUser
				 ],
				],
				[action    : 'setFieldValue',
				 ext       : ":labels value set to empty _to check $it : ",
				 expected  : 0,
				 parameters: [
						 issue: { -> defaultIssue[] },
						 field: "Labels",
						 value: " "
				 ],
				],
				[action    : 'transitionIssue',
				 ext       : ":USER_CONDITION_TS_50_TC_01_Case_01_ $it _when not satisfies the criteria: ",
				 expected  : -1,
				 parameters: [
						 issue     : { -> defaultIssue[] },
						 transition: it,
				 ],
				],
				[action    : 'setFieldValue',
				 ext       : ":assignee value set to $user _to check $it : ",
				 expected  : 0,
				 parameters: [
						 issue: { -> defaultIssue[] },
						 field: "Assignee",
						 value: user
				 ],
				],
				[action    : 'transitionIssue',
				 ext       : ":USER_CONDITION_TS_50_TC_01_Case_02_ $it _when satisfies the criteria: ",
				 expected  : 0,
				 parameters: [
						 issue     : { -> defaultIssue[] },
						 transition: it,
				 ],
				],
		])
	}
}


// USER_CONDITION_TS_50_TC_04_Verify the mode: at least one of the criteria configured below_ user in field creator
['verify_user_in_field_creator_should_be_in_at_least_one_field_reporter_assignee_labels'].each {
	if(!isCloud) {
		gint.taskHelper.add([
				[action    : 'setFieldValue',
				 ext       : ":assignee value set to $testUser _to check $it : ",
				 expected  : 0,
				 parameters: [
						 issue: { -> defaultIssue[] },
						 field: "Assignee",
						 value: testUser
				 ],
				],
				[action    : 'setFieldValue',
				 ext       : ":reporter value set to $testUser _to check $it : ",
				 expected  : 0,
				 parameters: [
						 issue: { -> defaultIssue[] },
						 field: "Reporter",
						 value: testUser
				 ],
				],
				[action    : 'setFieldValue',
				 ext       : ":labels value set to empty _to check $it : ",
				 expected  : 0,
				 parameters: [
						 issue: { -> defaultIssue[] },
						 field: "Labels",
						 value: " "
				 ],
				],
				[action    : 'transitionIssue',
				 ext       : ":USER_CONDITION_TS_50_TC_04_Case_01_ $it _when not satisfies the criteria: ",
				 expected  : -1,
				 parameters: [
						 issue     : { -> defaultIssue[] },
						 transition: it,
				 ],
				],
				[action    : 'setFieldValue',
				 ext       : ":assignee value set to $user _to check $it : ",
				 expected  : 0,
				 parameters: [
						 issue: { -> defaultIssue[] },
						 field: "Reporter",
						 value: user
				 ],
				],
				[action    : 'transitionIssue',
				 ext       : ":USER_CONDITION_TS_50_TC_04_Case_02_ $it _when satisfies the criteria: ",
				 expected  : 0,
				 parameters: [
						 issue     : { -> defaultIssue[] },
						 transition: it,
				 ],
				],
		])
	}
}

// USER_CONDITION_TS_22_TC_04_Verify for the Reverse condition checkbox under the current user Condition configuration page
['currentUser_should_not_be_in_fields_assignee_reporter_reverse'].each {
	if(!isCloud) {
		gint.taskHelper.add([
				[action    : 'setFieldValue',
				 ext       : ":assignee value set to $testUser _to check $it : ",
				 expected  : 0,
				 parameters: [
						 issue: { -> defaultIssue[] },
						 field: "Assignee",
						 value: testUser
				 ],
				],
				[action    : 'setFieldValue',
				 ext       : ":reporter value set to $testUser _to check $it : ",
				 expected  : 0,
				 parameters: [
						 issue: { -> defaultIssue[] },
						 field: "Reporter",
						 value: testUser
				 ],
				],
				[action    : 'setFieldValue',
				 ext       : ":labels value set to empty _to check $it : ",
				 expected  : 0,
				 parameters: [
						 issue: { -> defaultIssue[] },
						 field: "Labels",
						 value: " "
				 ],
				],
				[action    : 'transitionIssue',
				 ext       : ":USER_CONDITION_TS_22_TC_01_Case_01_ $it _when not satisfies the criteria: ",
				 expected  : 0,
				 parameters: [
						 issue     : { -> defaultIssue[] },
						 transition: it,
				 ],
				],
				[action    : 'setFieldValue',
				 ext       : ":assignee value set to $user _to check $it : ",
				 expected  : 0,
				 parameters: [
						 issue: { -> defaultIssue[] },
						 field: "Assignee",
						 value: user
				 ],
				],
				[action    : 'setFieldValue',
				 ext       : ":reporter value set to $user _to check $it : ",
				 expected  : 0,
				 parameters: [
						 issue: { -> defaultIssue[] },
						 field: "Reporter",
						 value: user
				 ],
				],
				[action    : 'setFieldValue',
				 ext       : ":labels value set to $user _to check $it : ",
				 expected  : 0,
				 parameters: [
						 issue: { -> defaultIssue[] },
						 field: "Labels",
						 value: user
				 ],
				],
				[action    : 'transitionIssue',
				 ext       : ":USER_CONDITION_TS_22_TC_01_Case_02_ $it _when satisfies the criteria: ",
				 expected  : -1,
				 parameters: [
						 issue     : { -> defaultIssue[] },
						 transition: it,
				 ],
				],
		])
	}
}

// USER_CONDITION_TS_51_TC_01_Verify the mode: at least one of the criteria configured below with or the field can be empty oprion.
['user_in_field_assignee_should_be_in_field_labels_or_field_empty'].each {
	if(!isCloud) {
		gint.taskHelper.add([
				[action    : 'setFieldValue',
				 ext       : ":assignee set to $testUser _to check $it : ",
				 parameters: [
						 issue: { -> defaultIssue[] },
						 field: "Assignee",
						 value: user
				 ],
				],
				[action    : 'setFieldValue',
				 ext       : ":labels set to $testUser _to check $it : ",
				 parameters: [
						 issue: { -> defaultIssue[] },
						 field: "Labels",
						 value: testUser
				 ],
				],
				[action    : 'transitionIssue',
				 ext       : ":USER_CONDITION_TS_51_TC_01_Case_01_ $it _when not satisfies the criteria: ",
				 expected  : -1,
				 parameters: [
						 issue     : { -> defaultIssue[] },
						 transition: it,
				 ],
				],
				[action    : 'setFieldValue',
				 ext       : ":Assignee value set to empty _to check $it : ",
				 expected  : 0,
				 parameters: [
						 issue: { -> defaultIssue[] },
						 field: "Assignee",
						 value: " "
				 ],
				],
				[action    : 'transitionIssue',
				 ext       : ":USER_CONDITION_TS_51_TC_01_Case_02_ $it _when satisfies the criteria_field is empty: ",
				 expected  : 0,
				 parameters: [
						 issue     : { -> defaultIssue[] },
						 transition: it,
				 ],
				],
		])
	}
}



 */

/*
1. The current user should match all the following criteria:
The user is the reporter : positive - current user is reporter
 negative - other user is reporter = "DONE"

2.The current user should match at least one of the following criteria:
The user is the assignee
The user is one of the following users: jmwe-qa
 positive: check when assignee is current user / current user is jmwe_qa
 negative: when assignee is not current user  /  current user is not jmwe_qa = "DONE"

3. The current user should match all the following criteria:
The user is one of the watchers
 positive: 1.add multiple watchers 2.add multiple watchers with current user 3. check login by other watchers
 negative: 1.current user not visible when not selected as watcher
4. configure with all options under criteria and check -positives and negatives
5. Active and inactive users
 */



