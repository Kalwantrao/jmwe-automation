buildscript {
    repositories {
        maven {
            url "https://plugins.gradle.org/m2/"
        }
    }
    dependencies {
        classpath "org.gint:gint-atlassian:3.8.4"
    }
}

apply plugin: 'org.gint.atlassian'
apply from: gint.resourceDirectory +'/src/common/utils.gradle'

tearDown()
addWorkflow()

def functionKey =  'com.innovalog.jmwe.jira-misc-workflow-extensions:separationofduties-condition'

def separationOfDutiesConditionOptions = [
        FROM_ANY_TO_TODO_STATUS : [defaultFieldsServer + "fromStatus=" + "toStatus=To Do"],
        FROM_INPROGRESS_TO_DONE_STATUS : [defaultFieldsServer + "fromStatus=In Progress" + "toStatus=Done"],
        FROM_DONE_TO_INPROGRESS_STATUS : [defaultFieldsServer + "fromStatus=Done" + "toStatus=In Progress"],
]

separationOfDutiesConditionOptions.eachWithIndex { transitions, fields, i ->
    if(!isCloud){
        addTransitionFunction(transitions, 'condition', fields, functionKey )
    }
}

createWorkflowScheme()
createProject()

def defaultIssue = createIssue([type: 'Task', summary: 'JMWE_Issue'], 'defaultIssue')

// SEPARATION_OF_DUTIES_CONDITION_TC_10_Case_01-Verify when issue never transitioned FROM status to TO status

separationOfDutiesConditionOptions.eachWithIndex { transition, fields, i->
    if(!isCloud) {
        gint.taskHelper.add([
                action    : 'transitionIssue',
                ext       : ": SEPARATION_OF_DUTIES_CONDITION_TC_10_Case_01_ $i _Verify when issue never transitioned_ $transition: ",
                expected  : 0,
                parameters: [
                        transition: transition,
                        issue     : { -> defaultIssue[] },
                ],
        ])
    }
}


// transition issue to check when the issues are transitioned from status to status
if(!isCloud) {
    gint.taskHelper.add([
            [action    : 'transitionIssue', ext: ' : To Done',
             parameters: [
                     transition: 'In Progress',
                     issue     : { -> defaultIssue[] },
             ],
            ],
            [action    : 'transitionIssue', ext: ' : To In Progress',
             parameters: [
                     transition: 'Done',
                     issue     : { -> defaultIssue[] },
             ],
            ],
            [action    : 'transitionIssue', ext: ' : again In Progress',
             parameters: [
                     transition: 'In Progress',
                     issue     : { -> defaultIssue[] },
             ],
            ],
            [action    : 'transitionIssue', ext: ' : To To Do',
             parameters: [
                     transition: 'To Do',
                     issue     : { -> defaultIssue[] },
             ],
            ],
    ])
}

//SEPARATION_OF_DUTIES_CONDITION_TC_10_Case_02-Verify when issue transitioned FROM status to TO status
separationOfDutiesConditionOptions.eachWithIndex { transition, fields, i->
    if(!isCloud) {
        gint.taskHelper.add([
                action    : 'transitionIssue',
                ext       : ": SEPARATION_OF_DUTIES_CONDITION_TC_10_Case_02_ $i _Verify when issue transitioned_ $transition : ",
                expected  : -1,
                parameters: [
                        transition: transition,
                        issue     : { -> defaultIssue[] },
                ],
        ])
    }
}
