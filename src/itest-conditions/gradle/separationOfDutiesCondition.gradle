buildscript {
    repositories {
        maven {
            url "https://plugins.gradle.org/m2/"
        }
    }
    dependencies {
        classpath "org.gint:gint-atlassian:3.8.4"
    }
}

apply plugin: 'org.gint.atlassian'
apply from: gint.resourceDirectory +'/src/common/utils.gradle'

tearDown()
addWorkflow()

def functionKey = functionKey.separationOfDutiesConditionServer

def defaultFields = [
               "correlationId=",
]
def separationOfDuties = [
        fromAny_ToDo : [defaultFields + "fromStatus=" + "toStatus=To Do"],
        fromToDo_Done : [defaultFields + "fromStatus=To Do" + "toStatus=Done"],
        fromInProgress_ToDo : [defaultFields + "fromStatus=In Progress" + "toStatus=To Do"],
        fromDone_InProgress : [defaultFields + "fromStatus=Done" + "toStatus=In Progress"]
]

// Configuration for conditions
['fromAny_ToDo'].each {
    def fields = defaultFields + "fromStatus=" + "toStatus=To Do"
    addTransitionFunction(it, 'condition', fields, functionKey )
}
['fromToDo_Done'].each {
    def fields = defaultFields + "fromStatus=To Do" + "toStatus=Done"
    addTransitionFunction(it, 'condition', fields, functionKey )
}
['fromInProgress_ToDo'].each {
    def fields = defaultFields + "fromStatus=In Progress" + "toStatus=To Do"
    addTransitionFunction(it, 'condition', fields, functionKey )
}
['fromDone_InProgress'].each {
    def fields = defaultFields + "fromStatus=Done" + "toStatus=In Progress"
    addTransitionFunction(it, 'condition', fields, functionKey )
}

createWorkflowScheme()
createProject()

def defaultIssue = createIssue([type: 'Task', summary: 'JMWE_Issue'], 'defaultIssue')

// checking the current status To Do and previous status In Progress
[
        'fromAny_ToDo',
        'fromInProgress_ToDo',
        'fromDone_InProgress',
        'fromToDo_Done'
].each {
    gint.taskHelper.add([
            action    : 'transitionIssue', ext: ' : when issue not transitioned between selected status ' + it,
            expected  : 0,
            parameters: [
                    transition: it,
                    issue: { -> defaultIssue[] },
            ],
    ])
}
gint.taskHelper.add([
        [action    : 'transitionIssue', ext: ' : To Done',
         parameters: [
                 transition: 'Done',
                 issue: { -> defaultIssue[] },
         ],
        ],
        [action    : 'transitionIssue', ext: ' : To In Progress',
         parameters: [
                 transition: 'In Progress',
                 issue: { -> defaultIssue[] },
         ],
        ],
        [action    : 'transitionIssue', ext: ' : To To Do',
         parameters: [
                 transition: 'To Do',
                 issue: { -> defaultIssue[] },
         ],
        ],
])
[
        'fromToDo_Done',
        'fromAny_ToDo',
        'fromInProgress_ToDo',
        'fromDone_InProgress'
].each {
    gint.taskHelper.add([
            [action    : 'transitionIssue', ext: ' : transition not visible when issue is transitioned between selected statuses ' + it,
             expected  : -1,
             parameters: [
                     transition: it,
                     issue: { -> defaultIssue[] },
             ],
            ],
    ])
}

