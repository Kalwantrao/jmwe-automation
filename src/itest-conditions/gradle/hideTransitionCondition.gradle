//To run  this using gradle open command line in root directory and run below command on windows
//gradlew -b src/itest-conditions/gradle/hideTransitionCondition.gradle -Pcli="acli jira" -Dclean

buildscript {
    def gintVersion = findProperty('gintVersion') ?: System.getenv('GINT_VERSION') ?: '+'
    dependencies {
        classpath 'org.gint:gint-atlassian:' + gintVersion
    }
    repositories {
        flatDir { dirs 'libs' } // for testing SNAPSHOT versions
        mavenLocal()
        mavenCentral()
        maven { url 'https://plugins.gradle.org/m2/' }
    }
}

apply plugin: 'org.gint.atlassian'
apply from: gint.directories.resource +'/common/tearDown.gradle'
apply from:'configConditions/addHideTransitionCondition.gradle'
apply from: gint.directories.resource + '/common/setUp.gradle'


def info = gint.getJiraHelper().getServerInfoWithVerify() // Verify access to Jira instance otherwise end test if server not available
def project = gint.getJiraHelper().getProjectKey()	//get project key using jira helper functions
def transition = 'hideTransitionFromUser'
def saved =	[:]
def savedIssues = [:]
def user = info.user

// Create issues
(1..1).each { number ->
def issueType = 'Bug'
def	summary = 'hideTransitionFromUser'
    gint.taskHelper.add([
        [action: 'createIssue', ext: number,
        dependsOn: true,
        group: 'create',
        project: project,
        parameters: [
            type: issueType,
            summary: summary ,
            description: 'hideTransitionFromUser' + number,
        ],
        stopOnFail: true,
        finalClosure: { Task task ->
            saved.issue = gint.searchForIssueKey(task.outData)
            savedIssues[number] = saved.issue
            gint.helper.logVarWithFormat('Create Issues to validate the hide Transition Condition')
        },
        ],
   ] )
}
// Transition issues when current status should be To Do
(1..1).each{ number ->
def data = ~/Client error: Workflow transition '${transition + number}' is not valid for issue ${project}-\d+./

    gint.taskHelper.add('transitionIssueAll', [
        [action: 'transitionIssue', ext: 'hideTransitionFromUser'+number,
            dependsOn: true,
            expected: [ -1 ] ,
            parameters: [
                issue: {-> savedIssues[number]  },
                transition: transition + number,
				],
           data:[ data  ],
            finalClosure:{ Task task ->
            	gint.helper.logVarWithFormat('Should throw error as transition should be hidden from user')

            }

        ],
    ])
}
