//To run  this using gradle open command line in root directory and run below command on windows
//gradlew -b src/itest-conditions/gradle/currentStatusCondition.gradle -Pcli="acli jira" -Dclean

buildscript {
    def gintVersion = findProperty('gintVersion') ?: System.getenv('GINT_VERSION') ?: '+'
    dependencies {
        classpath 'org.gint:gint-atlassian:' + gintVersion
    }
    repositories {
        flatDir { dirs 'libs' }
        mavenLocal()
        mavenCentral()
        maven { url 'https://plugins.gradle.org/m2/' }
    }
}
apply plugin: 'org.gint.atlassian'
apply from: gint.directories.resource + '/common/tearDown.gradle'
apply from: 'configConditions/addCurrentStatusCondition.gradle'
apply from: gint.directories.resource + '/common/setUp.gradle'

def info = gint.getJiraHelper().getServerInfoWithVerify() // Verify access to Jira instance otherwise end test if server not available
def project = gint.getJiraHelper().getProjectKey()	//get project key using jira helper functions
def user = info.user
def userqa1 = project.toLowerCase()+'qa1'
def userqa2 = project.toLowerCase()+'qa2'
def userdev1 = project.toLowerCase()+'dev1'
def userdev2 = project.toLowerCase()+'dev2'

def saved =	[:]
def savedIssues = [:]
def transition = 'currentStatusCondition'

// Create issues
(1..4).each { number ->
def type = 'Bug'
def summary
	if (number == 1)
		summary = 'currentStatusMustBeToDo'
	else if(number == 2)
		summary = 'currentStatusMustNotBeToDo'
	else if (number == 3)
		summary = 'checkWhenNoStatusSelected'
	else if(number == 4)
		summary = 'checkWhenNoStatusSelectedAndReverseSelected'
/* 
1. select all status checkbox
2. multiple conditions with To Do and In Progress
3. Add extension multiple times and check first should apply first FIFO
4. check the behaviour on custom statuses
5. check adding multiple custom statuses 
6. check behaviour on all issuetypes
7. check status should not be visible when status itself is selected as current status -> transition: Done ,Current status: In Progress , issueTransition:Done 
8. transition: Done , Current status : Done
9. transition: Done, current status: To Do, again add condition on transition: Done, current Status :Done
10. Check behaviour by adding postfunctions on same status also check fields
*/ 
    gint.taskHelper.add(
        action: 'createIssue', ext: number,
		dependsOn: true,
        group: 'create',
        project: project,
        parameters: [
            type: type,
            summary: summary ,
            description: 'currentStatusCondition' + number,
        ],
        stopOnFail: true,
        finalClosure: { Task task ->
            saved.issue = gint.searchForIssueKey(task.outData)
            savedIssues[number] = saved.issue
            gint.helper.log('Create Issues to validate the current status condition',saved)
        },
   )
}
// Transition issues when current status should be To Do
(1..4).each{ number ->
def expected
		if(number == 1)
		expected = [ 0 ]
	else if(number == 2)
		expected = [ -1 ]
	else if(number == 3)
		expected = [ -1 ]
	else if(number == 4)
		expected = [ 0 ]
def data
	if(number == 1)
		data = ~/Successfully transitioned issue ${project}-\d+ with transition '${transition + number}'./
	else if(number == 2)
		data = ~/Client error: Workflow transition '${transition + number}' is not valid for issue ${project}-\d+./
	else if(number == 3)
		data = ~/Client error: Workflow transition '${transition + number}' is not valid for issue ${project}-\d+./
	else if(number == 4)
		data = ~/Successfully transitioned issue ${project}-\d+ with transition '${transition + number}'./

    gint.taskHelper.add('transitionIssueToVerifyIfCurrentStatusToDo', [
        [action: 'transitionIssue', ext: '--WhenCurrentStatusIsToDo'+number,
		dependsOn: true,
            expected: expected ,
            parameters: [
                issue: {-> savedIssues[number]  },
                transition: transition + number,
				],
           data:[ data ],
            finalClosure:{ Task task ->
            	gint.helper.log('Verify if the current status is in selected status or not',saved)

            }

        ],
    ])
}

