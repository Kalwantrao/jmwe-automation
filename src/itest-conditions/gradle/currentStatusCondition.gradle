buildscript {
	repositories {
		maven {
			url "https://plugins.gradle.org/m2/"
		}
	}
	dependencies {
		classpath "org.gint:gint-atlassian:3.8.4"
	}
}

apply plugin: 'org.gint.atlassian'
apply from: gint.resourceDirectory +'/src/common/utils.gradle'

tearDown()
addWorkflow()

def functionKey = info?.isCloud ? 'com.atlassian.plugins.atlassian-connect-plugin:com.innovalog.jmwe.jira-misc-workflow-extensions__CurrentStatusCondition' : 'com.innovalog.jmwe.jira-misc-workflow-extensions:currentstatus-condition'

def defaultFieldsCloud= [
		"condition.id=d150ebe9-f65f-4199-ade5-c38062e8d5b9",
]

def currentStatusServer = [
		SELECT_CURRENT_STATUS_TODO : [ defaultFieldsServer + "issue_statuses=$statusIds.toDo", "not="],
		SELECT_CURRENT_STATUS_TODO_AND_REVERSE : [ defaultFieldsServer +  "issue_statuses=$statusIds.toDo", "not=yes" ],
]

def currentStatusCloud = [
		SELECT_CURRENT_STATUS_TODO :  [ defaultFieldsCloud + "condition.config-d150ebe9-f65f-4199-ade5-c38062e8d5b9={\"statusIds\":[$statusIds.toDo],\"options\":{\"not\":false},\"expression\":\"config.statusIds.includes(issue.status.id)\"}" ],
		SELECT_CURRENT_STATUS_TODO_AND_REVERSE : [	defaultFieldsCloud + "condition.config-d150ebe9-f65f-4199-ade5-c38062e8d5b9={\"statusIds\":[$statusIds.toDo],\"options\":{\"not\":true},\"expression\":\"!config.statusIds.includes(issue.status.id)\"}" ]
]

def currentStatusCondition = info?.isCloud ? currentStatusCloud : currentStatusServer
// Configuration for conditions

currentStatusCondition.eachWithIndex { transitions, fields, i->
	addTransitionFunction(transitions, 'condition', fields, functionKey)
}

createWorkflowScheme()
createProject()

def defaultIssue = createIssue([type: 'Task', summary: 'JMWE_Issue'], 'defaultIssue')

// CURRENT_STATUS_CONDITION_TC_10_Verify transition tab after apply Current Status Condition on ToDo status and current status of Issue is also ToDo
[
		'SELECT_CURRENT_STATUS_TODO',
].each {
	gint.taskHelper.add([
			action    : 'transitionIssue',
			ext: ": CURRENT_STATUS_CONDITION_TC_10-Verify transition tab $it after apply Current Status Condition on ToDo status and current status of Issue is also ToDo:",
			expected  : 0,
			parameters: [
					transition: it,
					issue: { -> defaultIssue[] },
			],
	])
}

// CURRENT_STATUS_CONDITION_TC_14-Verify transition eg $it tab on issue screen when apply Reverse condition with ToDo status and current status of issue is also ToDo
[
		'SELECT_CURRENT_STATUS_TODO_AND_REVERSE',
].each {
	gint.taskHelper.add([
			action    : 'transitionIssue',
			ext: ": CURRENT_STATUS_CONDITION_TC_14-Verify transition eg $it tab on issue screen when apply Reverse condition with ToDo status and current status of issue is also ToDo:",
			expected  : -1,
			parameters: [
					transition: it,
					issue: { -> defaultIssue[] },
			],
	])
}


/*
1.  Negative  - add current status condition with in progress and check on issue when issue status is to do = Need to addTransitionFunction on workflow step
2. Positive -  add current status condition with in progress and check on issue when issue status is in progress = "DONE"
3. add current status condition with in progress,done and to do and check on issue when issue status is in progress, done, to to , in review
4. add current status condition with in progress,done and to do and check on issue when issue status is in progress, done, to to , in review - reverse
5. add current status condition with in progress,done and to do and check on issue when issue status is in progress
6. add current status condition with in progress,done and to do and check on issue when issue status is in progress - reverse
 */



