buildscript {
    repositories {
        maven {
            url "https://plugins.gradle.org/m2/"
        }
    }
    dependencies {
        classpath "org.gint:gint-atlassian:3.8.4"
    }
}

apply plugin: 'org.gint.atlassian'
apply from: gint.resourceDirectory +'/src/common/utils.gradle'

tearDown()
addWorkflow()


def fieldsToRemoveServer = [
        "currentIssue",
]
fieldsToRemoveServer.each { key ->
    relatedIssueServer.remove(key)
}

def relatedIssue = info?.isCloud ? relatedIssueCloud : relatedIssueServer
def functionKey = info?.isCloud? functionKey.relatedIssuesStatusvalidatorCloud : functionKey.relatedIssuesStatusValidatorServer
def errorMessage = "Check linked issues status"

def defaultFieldsCloud = ["validator.id=7e7f0c41-7aa4-4ff9-896c-ff1fe247a67f"]

def defaultFields = [ "errorMessage=$errorMessage", "correlationId=" ]

def issueType = [
        any : [ "selectedIssueType=" ],
        story : [ "selectedIssueType=$issueType.story" ],
        task : [ "selectedIssueType=$issueType.task" ],
        bug : [ "selectedIssueType=$issueType.bug" ],
        initiative: [ "selectedIssueType=$issueType.initiative" ]
]
def mode = [
        all : [ "conditionMode=all-in-status" ],
        one : ["conditionMode=one-in-status"],
        none : ["conditionMode=none-in-status"],
        oneNot : ["conditionMode=one-not-in-status"]
]
def statuses = [
        inProgress : ["issue_statuses=$statusIds.inProgress" ],
        toDo : [ "issue_statuses=$statusIds.toDo" ],
        inReview : [ "issue_statuses=$statusIds.inReview" ],
        done : [ "issue_statuses=$statusIds.done" ]
]

def modeCloud = [
        "validator.config-7e7f0c41-7aa4-4ff9-896c-ff1fe247a67f={\"conditionalValidation\":false,\"selectedLinkTypeId\":\"jira_subtask_link\",\"selectedLinkTypeDirection\":\"outward\",\"selectedIssueTypeId\":\"\",\"validatorMode\":\"allInStatus\",\"statusIds\":[3],\"expression\":\"issue.subtasks.every(linkedIssue => config.statusIds.includes(linkedIssue.status.id))\"}"
]

relatedIssue.eachWithIndex { key, value, i ->
    def server = defaultFields + "selectedLinkType=$value" + issueType.any + mode.all + statuses.inProgress + conditionalValidation.no
    def cloud = "fieldsCloud"
    def fields = info?.isCloud ? cloud : server
    addTransitionFunction('allIssuesMustBe_InProgress' + i , 'validator', fields, functionKey)
}
relatedIssue.eachWithIndex { key, value, i ->
    def server = defaultFields + "selectedLinkType=$value" + issueType.any + mode.one + statuses.inProgress + conditionalValidation.no
    def cloud = "fieldsCloud"
    def fields = info?.isCloud ? cloud : server
    addTransitionFunction('atLeastOneIssueMustBe_InProgress' + i , 'validator', fields, functionKey)
}
relatedIssue.eachWithIndex { key, value, i ->
    def server = defaultFields + "selectedLinkType=$value" + issueType.any + mode.none + statuses.inProgress + conditionalValidation.no
    def cloud = "fieldsCloud"
    def fields = info?.isCloud ? cloud : server
    addTransitionFunction('noIssueMustBe_InProgress' + i , 'validator', fields, functionKey)
}
relatedIssue.eachWithIndex { key, value, i ->
    def server = defaultFields + "selectedLinkType=$value" + issueType.any + mode.oneNot + statuses.inProgress + conditionalValidation.no
    def cloud = "fieldsCloud"
    def fields = info?.isCloud ? cloud : server
    addTransitionFunction('oneIssueMustNotBe_InProgress' + i , 'validator', fields, functionKey)
}

relatedIssue.eachWithIndex { key, value, i ->
    def server = defaultFields + "selectedLinkType=$value" + issueType.any + mode.all + statuses.toDo + conditionalValidation.no
    def cloud = "fieldsCloud"
    def fields = info?.isCloud ? cloud : server
    addTransitionFunction('allIssuesMustBe_ToDo' + i , 'validator', fields, functionKey)
}

relatedIssue.eachWithIndex { key, value, i ->
    def server = defaultFields + "selectedLinkType=$value" + issueType.any + mode.one + statuses.toDo + conditionalValidation.no
    def cloud = "fieldsCloud"
    def fields = info?.isCloud ? cloud : server
    addTransitionFunction('atLeastOneIssueMustBe_ToDo' + i , 'validator', fields, functionKey)
}

relatedIssue.eachWithIndex { key, value, i ->
    def server = defaultFields + "selectedLinkType=$value" + issueType.any + mode.none + statuses.toDo + conditionalValidation.no
    def cloud = "fieldsCloud"
    def fields = info?.isCloud ? cloud : server
    addTransitionFunction('noIssueMustBe_ToDo' + i , 'validator', fields, functionKey)
}

relatedIssue.eachWithIndex { key, value, i ->
    def server = defaultFields + "selectedLinkType=$value" + issueType.any + mode.oneNot + statuses.toDo + conditionalValidation.no
    def cloud = "fieldsCloud"
    def fields = info?.isCloud ? cloud : server
    addTransitionFunction('oneIssueMustNotBe_ToDo' + i , 'validator', fields, functionKey)
}

['allIssuesInProgress_Task'].each {
    def server = defaultFields + "selectedLinkType=$relatedIssueServer.parentIssue" + issueType.task + mode.all + statuses.inProgress + conditionalValidation.no
    def cloud = "fieldsCloud"
    def fields = info?.isCloud ? cloud : server
    addTransitionFunction( it, 'validator', fields, functionKey)
}

['allIssuesInProgress_Story'].each {
    def server = defaultFields + "selectedLinkType=$relatedIssueServer.parentIssue" + issueType.story + mode.all + statuses.inProgress + conditionalValidation.no
    def cloud = "fieldsCloud"
    def fields = info?.isCloud ? cloud : server
    addTransitionFunction( it, 'validator', fields, functionKey)
}
['allIssuesInProgress_ifConditionTrue'].each {
    def server = defaultFields + "selectedLinkType=$relatedIssueServer.subtask" + issueType.any + mode.all + statuses.inProgress + conditionalValidation.yes
    def cloud = "fieldsCloud"
    def fields = info?.isCloud ? cloud : server
    addTransitionFunction( it, 'validator', fields, functionKey)
}

createWorkflowScheme()
createProject()

def defaultIssue = createIssue([type: 'Task', summary: 'JMWE_Issue'], 'current')
def parent = createIssue([type: 'Task', summary: 'JMWE_Issue'], 'parent')
def subtask = createIssue([type: 'Sub-task', summary: 'JMWE_Issue', parent: { -> parent[] }], 'Sub-task')
def subtask2 = createIssue([type: 'Sub-task', summary: 'Subtask2', parent: { -> parent[] }], 'Sub-task2')
def subtask3 = createIssue([type: 'Sub-task', summary: 'Subtask3', parent: { -> parent[] }], 'Sub-task3')
def epic = createIssue([type: 'Epic', summary: 'JMWE_Issue', field: "Epic Name", value: "JMWE_Issue"], 'Epic')
def issueBelongsToEpic = createIssue([type: 'Task', summary: 'JMWE_Issue', field: "Epic Link", value: {->epic[]}], 'BelongsToEpic')
def issueBelongsToEpic2 = createIssue([type: 'Task', summary: 'issueBelongsToEpic2', field: "Epic Link", value: {->epic[]}], 'BelongsToEpic2')
def issueBelongsToEpic3 = createIssue([type: 'Task', summary: 'issueBelongsToEpic3', field: "Epic Link", value: {->epic[]}], 'BelongsToEpic3')
def initiative = createIssue([type: 'Initiative', summary: 'JMWE_Issue'], 'Initiative')
def epic_initiative = createIssue([type: 'Epic', summary: 'JMWE_Issue', field: "Epic Name", value: "JMWE_Issue"], 'Epic_initiative')
def epic_initiative2 = createIssue([type: 'Epic', summary: 'epic_initiative2', field: "Epic Name", value: "JMWE_Issue"], 'Epic_initiative2')
def epic_initiative3 = createIssue([type: 'Epic', summary: 'epic_initiative3', field: "Epic Name", value: "JMWE_Issue"], 'Epic_initiative3')
def issueLinks = createIssue([type: 'Task', summary: 'JMWE_Issue'], 'issueLinks')
def blocks = createIssue([type: 'Task', summary: 'JMWE_Issue'], 'blocks')
def blocks2 = createIssue([type: 'Task', summary: 'blocks2'], 'blocks2')
def blocks3 = createIssue([type: 'Task', summary: 'blocks3'], 'blocks3')
def clones = createIssue([type: 'Task', summary: 'JMWE_Issue'], 'clones')
def clones2 = createIssue([type: 'Task', summary: 'clones2'], 'clones2')
def clones3 = createIssue([type: 'Task', summary: 'clones3'], 'clones3')
def duplicates = createIssue([type: 'Task', summary: 'JMWE_Issue'], 'duplicates')
def duplicates2 = createIssue([type: 'Task', summary: 'duplicates2'], 'duplicates2')
def duplicates3 = createIssue([type: 'Task', summary: 'duplicates3'], 'duplicates3')
def relatesTo = createIssue([type: 'Task', summary: 'JMWE_Issue'], 'relatesTo')
def relatesTo2 = createIssue([type: 'Task', summary: 'relatesTo2'], 'relatesTo2')
def relatesTo3 = createIssue([type: 'Task', summary: 'relatesTo3'], 'relatesTo3')
def jqlIssue = createIssue([type: 'Task', summary: 'JQL_ISSUE'], 'jqlIssue')
def jqlIssue2 = createIssue([type: 'Task', summary: 'JQL_ISSUE'], 'jqlIssue2')
def jqlIssue3 = createIssue([type: 'Task', summary: 'JQL_ISSUE'], 'jqlIssue3')

updateIssue([issue: {->epic_initiative[]}, field: "Parent Link", value: {->initiative[]}], "parent initiative child epic")
updateIssue([issue: {->epic_initiative2[]}, field: "Parent Link", value: {->initiative[]}], "parent initiative child epic2")
updateIssue([issue: {->epic_initiative3[]}, field: "Parent Link", value: {->initiative[]}], "parent initiative child epic3")

def linkIssuesMap = [
        blocks : {->blocks[]},
        clones : {->clones[]},
        duplicates : {->duplicates[]},
        'relates to': {->relatesTo[]}
]
linkIssuesMap.eachWithIndex { key, value, i ->
    linkIssue([issue: {->issueLinks[]}, toIssue: value, link: "$key"], key)
}
def linkIssuesMap2 = [
        blocks : {->blocks2[]},
        clones : {->clones2[]},
        duplicates : {->duplicates2[]},
        'relates to': {->relatesTo2[]}
]
linkIssuesMap2.eachWithIndex { key, value, i ->
    linkIssue([issue: {->issueLinks[]}, toIssue: value, link: "$key"], key + 2)
}

def linkIssuesMap3 = [
        blocks : {->blocks3[]},
        clones : {->clones3[]},
        duplicates : {->duplicates3[]},
        'relates to': {->relatesTo3[]}
]
linkIssuesMap3.eachWithIndex { key, value, i ->
    linkIssue([issue: {->issueLinks[]}, toIssue: value, link: "$key"], key + 3)
}

def relatedIssuesMapCloud = [
        {->issueLinks[]} : {->blocks[]},
        {->issueLinks[]} : {->blocks[]},
        {->blocks[]} : {->issueLinks[]},
        {->issueLinks[]} : {->clones[]},
        {->clones[]} : {->issueLinks[]},
        {->issueLinks[]} : {->duplicates[]},
        {->duplicates[]} : {->issueLinks[]},
        {->issueLinks[]} : {->relatesTo[]},
]

def relatedIssuesMapServer = [
        {->parent[]} : {->subtask[]},
        {->subtask[]} : {->parent[]},
        {->epic[]} : {->issueBelongsToEpic[]},
        {->issueBelongsToEpic[]} : {->epic[]},
        {-> initiative[]} : {->epic_initiative[]},
        {-> epic_initiative[]} : {->initiative[]},
        {->issueLinks[]} : {->blocks[]},
        {->issueLinks[]} : {->blocks[]},
        {->blocks[]} : {->issueLinks[]},
        {->issueLinks[]} : {->clones[]},
        {->clones[]} : {->issueLinks[]},
        {->issueLinks[]} : {->duplicates[]},
        {->duplicates[]} : {->issueLinks[]},
        {->issueLinks[]} : {->relatesTo[]},
        {->issueLinks[]} : {->relatesTo[]},
        {->issueLinks[]} : {->jqlIssue[]}
]

def relatedIssuesMap = info?.isCloud ? relatedIssuesMapCloud : relatedIssuesMapServer

['oneIssueMustNotBe_InProgress','noIssueMustBe_InProgress'].collect {
    relatedIssuesMap.eachWithIndex { key, value, i ->
        gint.taskHelper.add([
                [action    : 'transitionIssue', ext: ': when linked issues not in selected status ie In Progress_checkSuccess :'+ it + i,
                 parameters: [
                         issue     : key,
                         transition: it + i,
                 ],
                 failData: [ /$errorMessage/],
                ],
        ])
    }
}

['allIssuesMustBe_InProgress','atLeastOneIssueMustBe_InProgress'].collect {
    relatedIssuesMap.eachWithIndex { key, value, i ->
        gint.taskHelper.add([
                [action    : 'transitionIssue', ext: ': when linked issues not in selected status ie In Progress_check error :' + it +i,
                 expected  : -3,
                 parameters: [
                         issue     : key,
                         transition: it + i,
                 ],
                 data :[/$errorMessage/ ],
                ],
        ])
    }
}

['oneIssueMustNotBe_ToDo','noIssueMustBe_ToDo'].collect {
    relatedIssuesMap.eachWithIndex { key, value, i ->
        gint.taskHelper.add([
                [action    : 'transitionIssue', ext: ': when all linked issues in selected status ie To Do_checkError :'+ it + i,
                 expected: -3,
                 parameters: [
                         issue     : key,
                         transition: it + i,
                 ],
                  data :[/$errorMessage/ ],
                ],
        ])
    }
}

['allIssuesMustBe_ToDo','atLeastOneIssueMustBe_ToDo'].collect {
    relatedIssuesMap.eachWithIndex { key, value, i ->
        gint.taskHelper.add([
                [action    : 'transitionIssue', ext: ': when all linked issues in selected status ie To Do_check success :' + it +i,
                 expected  : 0,
                 parameters: [
                         issue     : key,
                         transition: it + i,
                 ],
                 failData: [ /$errorMessage/],
                ],
        ])
    }
}

['allIssuesInProgress_Task'].each {
    gint.taskHelper.add([
            [action    : 'transitionIssue', ext: ': when issueType is task type :' + it,
             expected  : -3,
             parameters: [
                     issue     : {->subtask[]},
                     transition: it,
             ],
                    data: [ /$errorMessage/],
            ],
            [action: 'updateIssue',ext: it,
             parameters: [
                     issue: {->parent[]},
                     issueType: 'Story'
             ]
            ],
            [action    : 'transitionIssue', ext: ': when issueType is story type :' + it,
             expected  : 0,
             parameters: [
                     issue     : {->subtask[]},
                     transition: it,
             ],
             failData: [ /$errorMessage/],
            ],
    ]
    )
}
['allIssuesInProgress_Story'].each {
    gint.taskHelper.add([
            [action    : 'transitionIssue', ext: ': when issueType is story type :' + it,
             expected  : -3,
             parameters: [
                     issue     : {->subtask[]},
                     transition: it,
             ],
             data: [ /$errorMessage/],
            ],
            [action: 'updateIssue',ext: it,
             parameters: [
                     issue: {->parent[]},
                     issueType: 'Task'
             ]
            ],
            [action    : 'transitionIssue', ext: ': when issueType is task type :' + it,
             expected  : 0,
             parameters: [
                     issue     : {->subtask[]},
                     transition: it,
             ],
             failData: [ /$errorMessage/],
            ],
    ]
    )
}
['allIssuesInProgress_ifConditionTrue'].each {
    gint.taskHelper.add([
            [action    : 'transitionIssue', ext: ': when conditional validation is false :' + it,
             expected  : 0,
             parameters: [
                     issue     : {->parent[]},
                     transition: it,
             ],
             failData: [ /$errorMessage/],
            ],
            [action: 'updateIssue',ext: it,
             parameters: [
                     issue: {->parent[]},
                     priority: 'High'
             ]
            ],
            [action    : 'transitionIssue', ext: ': when conditional validation is true :' + it,
             expected  : -3,
             parameters: [
                     issue     : {->parent[]},
                     transition: it,
             ],
                    data: [/$errorMessage/]
            ],
    ]
    )

}

