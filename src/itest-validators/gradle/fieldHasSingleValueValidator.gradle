buildscript {
	repositories {
		maven {
			url "https://plugins.gradle.org/m2/"
		}
	}
	dependencies {
		classpath "org.gint:gint-atlassian:3.8.4"
	}
}

apply plugin: 'org.gint.atlassian'
apply from: gint.resourceDirectory +'/src/common/utils.gradle'

tearDown()
addWorkflow()

def defaultFieldsServer = [
		"correlationId=",
]
def fieldsList = [
		labels : 'labels',
		fixVersions : 'fixVersions',
		affectsVersions : 'versions',
		components : 'components',
]
def functionKey = functionKey.fieldHasSingleValueValidatorServer

def testUser =  info?.isCloud ? cloudUser : serverUser
// Configuration for validator

fieldsList.eachWithIndex { field, value, i ->
	def fields = defaultFieldsServer +"conditionalValidation=no" + "field=$value"
	addTransitionFunction( field  + 'hasSingleValue', 'validator', fields, functionKey )
}

fieldsList.eachWithIndex { field, value, i ->
	def fields = defaultFieldsServer +"conditionalValidation=yes" + "field=$value" + "conditionalValidationScript=$groovyExpression.getIssuetype"
	addTransitionFunction(field + 'conditionalValidation' , 'validator', fields, functionKey )
}

createWorkflowScheme()
createProject()

(1..2).each {
	gint.taskHelper.addSetUp([
			[action: 'addVersion', ext: ': create versions : ' + it,
				parameters: [
						project: projectName,
						version: it
				]
			],
			[action: 'addComponent', ext: ': create Component : ' + it,
				parameters: [
						project: projectName,
						component: 'component' + it
				],
			]
	 ])
}
def defaultIssue = createIssue([type: 'Task', summary: 'JMWE_Issue', labels: 'label1', fixVersions: 1, affectsVersions: 1, components: 'component1'], 'defaultIssue')

// checking the current status To Do and previous status In Progress
['hasSingleValue','conditionalValidation'].each {
			fieldsList.eachWithIndex { field, value, i ->
				gint.taskHelper.add(
						[action    : 'transitionIssue', ext: " : custom error when field_$field not provided during transition" + it,
						 expected  : 0,
						 parameters: [
								 transition: field + it,
								 issue     : { -> defaultIssue[] },
						 ],
						],
				)
	}
}
gint.taskHelper.add(
		[action: 'updateIssue', ext: ': add field more than one value',
		 parameters: [
				 issue: {->defaultIssue[]},
				 fixVersions: 2,
				 affectsVersions: 2,
				 components: 'component2',
				 append: null
		 ]
		],
)
gint.taskHelper.add(
		action: 'addLabels',
			parameters:[
			        issue: {->defaultIssue[]},
					labels: 'label2',
			]
)
['hasSingleValue','conditionalValidation'].each {
			fieldsList.eachWithIndex { field, value, i ->
				gint.taskHelper.add(
						[action    : 'transitionIssue', ext: " : Should throw error when field_$field has more than one value" + it,
						 expected  : -3,
						 parameters: [
								 transition: field + it,
								 issue     : { -> defaultIssue[] },
						 ],
						],
				)
	}
}

gint.taskHelper.add(
		[action: 'updateIssue', ext: ': change issue type',
		 parameters: [
				 issue: {->defaultIssue[]},
				 issueType: 'Story',
			 ]
		],
)
fieldsList.eachWithIndex { field, value, i ->
	gint.taskHelper.add(
			[action    : 'transitionIssue', ext: " : should not throw error when conditional validation false : $field",
			 expected  : 0,
			 parameters: [
					 transition: field + 'conditionalValidation',
					 issue: { -> defaultIssue[] },
			 ],
			]
	)
}

/*
1. check only multi valued fields - "Done"
2 check custom multi value field - pos and neg = // ToDo "Need to add custom fields"
 */



