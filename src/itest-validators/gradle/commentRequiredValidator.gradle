buildscript {
    repositories {
        maven {
            url "https://plugins.gradle.org/m2/"
        }
    }
    dependencies {
        classpath "org.gint:gint-atlassian:3.8.4"
    }
}

apply plugin: 'org.gint.atlassian'
apply from: gint.resourceDirectory +'/src/common/utils.gradle'

def customErrorMessage = "custom error message"
def systemErrorMessage = "You must provide a Comment"

def defaultFieldsServer = [
        verify_the_error_message: ["errorMessage=$customErrorMessage","groups=","showAsterisk=no","correlationId="],
        verify_the_system_error_message: ["errorMessage=","groups=","showAsterisk=no","correlationId="],
        verify_the_condition_groovy_expression : ["conditionalValidation=yes","conditionalValidationScript=$groovyExpression.getIssuetype","errorMessage=","groups=","showAsterisk=no","correlationId="],
        comment_required_if_not_from_selectedGroup : ["errorMessage=","groups=jira-administrators","showAsterisk=no","correlationId="]
]

def defaultFieldsCloud = [
        verify_the_error_message : [
                "validator.id=ba2aae99-13c1-422b-933c-1c16e0739d3a",
                "validator.config-ba2aae99-13c1-422b-933c-1c16e0739d3a={\"problems\":[],\"errorMessage\":\"$customErrorMessage\",\"expression\": \"!!issue.comments && issue.comments.length > 0 && issue.comments.some(comment => comment.id == null)\"}"
        ],
        verify_the_system_error_message : [
                "validator.id=ba2aae99-13c1-422b-933c-1c16e0739d3a",
                "validator.config-ba2aae99-13c1-422b-933c-1c16e0739d3a={\"problems\":[],\"expression\":\"!!issue.comments && issue.comments.length > 0 && issue.comments.some(comment => comment.id == null)\"}"
        ],
        verify_the_condition_groovy_expression : [
                "validator.id=ba2aae99-13c1-422b-933c-1c16e0739d3a",
                "validator.config-ba2aae99-13c1-422b-933c-1c16e0739d3a={\"problems\":[],\"conditionalValidation\":true,\"conditionalValidationExpression\":\"!!issue.issueType && issue.issueType.name == 'Task'\",\"expression\":\"!(!!issue.issueType && issue.issueType.name == 'Task') || !!issue.comments && issue.comments.length > 0 && issue.comments.some(comment => comment.id == null)\"}"
        ]
]

def functionKey = info?.isCloud ? 'com.atlassian.plugins.atlassian-connect-plugin:com.innovalog.jmwe.jira-misc-workflow-extensions__CommentRequiredValidator' : 'com.innovalog.jmwe.jira-misc-workflow-extensions:commentrequired-validator'
def fields = info?.isCloud ? defaultFieldsCloud : defaultFieldsServer

// Configuration for validator
fields.eachWithIndex { key, value, i ->
    addTransitionFunction(key, 'validator', value, functionKey)
}

createWorkflowScheme()
createProject()

def defaultIssue = createIssue([type: 'Task', summary: 'JMWE_Issue'], 'defaultIssue')

// COMMENT_REQUIRED_VALIDATOR_TC_09_Verify the Error message_On the issue transition_if the user did not add a comment_added error message must be displayed to the user
[
        'verify_the_error_message',
].each {
    gint.taskHelper.add([
            [action    : 'transitionIssue',
             ext: ":COMMENT_REQUIRED_VALIDATOR_TC_09_Case_ 01-Verify the Error message_On the issue transition_if the user did not add a comment_added error message must be displayed to the user_when comment not provided:",
             expected  : -3,
             parameters: [
                     transition: it,
                     issue: { -> defaultIssue[] },
             ],
             data: [ /$customErrorMessage/ ]
            ],
            [action    : 'transitionIssue',
             ext: ":COMMENT_REQUIRED_VALIDATOR_TC_09_Case_02-Verify the Error message_On the issue transition_if the user did not add a comment_added error message must be displayed to the user_when comment provided:",
             expected  : 0,
             parameters: [
                     transition: it,
                     issue: { -> defaultIssue[] },
                     comment: 'test_Comment'
             ],
             failData: [ /$customErrorMessage/ ]
            ]
    ]
    )
}

// COMMENT_REQUIRED_VALIDATOR_TC_09_Case_02_Verify the system error message
[
        'verify_the_system_error_message',
].each {
    gint.taskHelper.add([
            [action    : 'transitionIssue',
             ext: ":COMMENT_REQUIRED_VALIDATOR_TC_9_Case_02_A_Verify the system error message_when comment not provided:",
             expected  : -3,
             parameters: [
                     transition: it,
                     issue: { -> defaultIssue[] },
             ],
             data: [ /$systemErrorMessage/ ]
            ],
            [action    : 'transitionIssue',
             ext: ":COMMENT_REQUIRED_VALIDATOR_TC_9_Case_02_B_Verify the system error message_when comment provided:",
             expected  : 0,
             parameters: [
                     transition: it,
                     issue: { -> defaultIssue[] },
                     comment: 'test_Comment'
             ],
             failData: [ /$systemErrorMessage/ ]
            ]
    ]
    )
}

// COMMENT_REQUIRED_VALIDATOR_TC_09_Verify the Condition groovy expression
[
        'verify_the_condition_groovy_expression',
].each {
    gint.taskHelper.add([
            [action    : 'transitionIssue',
             ext: ":COMMENT_REQUIRED_VALIDATOR_TC_13_Case_01-Verify the Condition groovy expression_when condition returns true and comment not provided:",
             expected  : -3,
             parameters: [
                     transition: it,
                     issue: { -> defaultIssue[] },
             ],
             data: [ /$systemErrorMessage/ ]
            ],
            [action    : 'transitionIssue',
             ext: ":COMMENT_REQUIRED_VALIDATOR_TC_13_Case_02-Verify the Condition groovy expression_when condition returns true and comment provided:",
             expected  : 0,
             parameters: [
                     transition: it,
                     issue: { -> defaultIssue[] },
                     comment: 'test_Comment'
             ],
             failData: [ /$systemErrorMessage/ ]
            ],
            [action: 'updateIssue',
             ext: ': change issue type',
             parameters: [
                     issue: {->defaultIssue[]},
                     issueType: 'Story'
             ]
            ],
            [action    : 'transitionIssue',
             ext: ":COMMENT_REQUIRED_VALIDATOR_TC_13_Case_03-Verify the Condition groovy expression_when condition returns false and comment not provided:",
             expected  : 0,
             parameters: [
                     transition: it,
                     issue: { -> defaultIssue[] },
             ],
             failData: [ /$systemErrorMessage/ ]
            ]

    ]
    )
}

// COMMENT_REQUIRED_VALIDATOR_TC_10_Verify the Groups allowed to omit the comment dropdown_On selecting the group from the drop-down_that group will be omitted from the validator
['comment_required_if_not_from_selectedGroup'].each {
    gint.taskHelper.add([
            [action: 'transitionIssue',
             onlyIf: info?.isServer?
             ext: ":COMMENT_REQUIRED_VALIDATOR_TC_10_Verify the Groups allowed to omit the comment dropdown_On selecting the group from the drop-down_that group will be omitted from the validator:",
             expected: 0,
             parameters:[
                     issue:  {defaultIssue[]},
                     transition: it
             ],
             failData: [/$systemErrorMessage/]
            ],
    ])
}
def transitionByUserTask =  { transition, userId, issue, data, expected ->
    gint.taskHelper.add(
            [expected: expected,
             name: 'check transition trigger by other user'+ transition,
             onlyIf: info?.isServer?
             cmd : /acli $userId -a transitionIssue --issue $issue --transition $transition/,
             data: ( data == null ? data : [:]),
             finalClosure: {Task task ->
                 assert task.result == expected
             }
            ]
    )
}
//transitionByUserTask('comment_required_if_not_from_selectedGroup', testUser, {->defaultIssue[]}, null, -3)
/*
DONE : 1. If a Comment is not provided, report the following error: You must provide a Comment. - positive and negatives = "Done"
DONE:  2. If a Comment is not provided, report the following error: customError msg. - positive and negatives = "Done"
DONE:  3. If a Comment is not provided, report the following error: You must provide a Comment.
          Users in any of following groups will not need to provide a comment:validate one group = "Done"
DONE:  4. If a Comment is not provided, report the following error: You must provide a Comment.
          This validation only applies if the following condition is true:!!issue.get("assignee")     -positive and negatives = "Done"
 */