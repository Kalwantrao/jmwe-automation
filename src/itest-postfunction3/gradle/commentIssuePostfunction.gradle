buildscript {
    repositories {
        maven {
            url "https://plugins.gradle.org/m2/"
        }
    }
    dependencies {
        classpath "org.gint:gint-atlassian:3.8.4"
    }
}

apply plugin: 'org.gint.atlassian'
apply from: gint.resourceDirectory +'/src/itest-postfunction3/postfunction.gradle'

def functionKey = info?.isCloud ? "com.atlassian.plugins.atlassian-connect-plugin:com.innovalog.${testCloudBuild}__CommentIssueFunction" : 'com.innovalog.jmwe.jira-misc-workflow-extensions:commentIssue-function'

def JIRA_ADMIN_PROJECT_ROLE_ID = getProjectRoleId("Administrators")
def jiraAdminRoleId = {->JIRA_ADMIN_PROJECT_ROLE_ID.getAt(0).trim()}

def JIRA_TEST_PROJECT_ROLE_ID = getProjectRoleId("testprojectrole")
def testProjectRoleId = {->JIRA_TEST_PROJECT_ROLE_ID.getAt(0).trim()}

def JIRA_ADMIN_GROUP_ID= getGroupId("jira-admin", info?.isCloud? "jira-admins.*": "jira-administrators")
def jiraAdminGroup = {->JIRA_ADMIN_GROUP_ID.getAt(0).trim()}

def TEST_GROUP_ID= getGroupId("testgroup", info?.isCloud? "testgroup.*" : "testgroup")
def testGroupId = {->TEST_GROUP_ID.getAt(0).trim()}

String addCommentByTemplate = "add_comment_to_related_issue_by_template"
String addCommentByExpression = "add_comment_to_related_issue_by_expression"
String addCommentIfConditionTrue = "add_comment_to_related_issue_ifConditionTrue"
String addCommentVisibleToAdminGroup = 'add_comment_visible_to_admin_group_users'
String addCommentVisibleToTestGroup = 'add_comment_visible_to_test_group_users'
String addCommentVisibleToAdminProjectRole = 'add_comment_visible_to_admin_project_role_users'
String addCommentVisibleToTestProjectRole = 'add_comment_visible_to_test_project_role_users'
String addCommentRunAsUser = 'add_comment_run_as_'

def commentVisibility = [
        notSelected : [ "restrictToGroup=", "restrictToProjectRole=" ],
        jiraAdminGroups : [ "restrictToGroup=jira-administrators", "restrictToProjectRole=" ],
        jiraAdminRoles : [ "restrictToGroup=", "restrictToProjectRole=$jiraAdminRoleId" ],
        testGroupUsers : ["restrictToGroup=$testGroup", "restrictToProjectRole="],
        testProjectRoleUsers : ["restrictToGroup=", "restrictToProjectRole=$testProjectRoleId"]
]

def relatedIssue = [:]
def relatedIssuesMap = [:]

relatedIssuesList.each{
    relatedIssue.putAll(createRelatedIssuesMap('CONFIGURATION', it, projectName, " "))
    relatedIssuesMap.putAll(createRelatedIssuesMap('TRANSITION', it, projectName, " "))
}

relatedIssue.eachWithIndex { key, value, i ->
    def transition = addCommentByTemplate + i
    def server =  ["valueType=template" , "value=$transition" , "selectedLinkType=$value"]
    def cloud =  "{$conditionalExecution.false,\"targetIssue\":\"$value\",\"comment\":\"$transition\",\"restrictToInternal\":false,\"restrictToGroup\":\"\",$runAsUser.currentUser}"
    addTransitionFunction( transition, 'postfunction', info?.isCloud ? cloud : server, functionKey)
}

relatedIssue.take(1).eachWithIndex { key, value, i ->
    def transition = addCommentByExpression + i
    def server =  ["valueType=expression" , "value=$groovyExpression.getDescription" , "selectedLinkType=$value"]
    if(!isCloud) {
        addTransitionFunction(transition, 'postfunction', server, functionKey)
    }
}

relatedIssue.take(1).eachWithIndex { key, value, i ->
    def transition = addCommentIfConditionTrue + i
    def cloud =  "{$conditionalExecution.true,\"targetIssue\":\"$value\",\"comment\":\"$transition\",\"restrictToInternal\":false,\"restrictToGroup\":\"\",\"runAsType\":\"currentUser\"}"
    def server =  ["valueType=template" , "value=$transition" , commentVisibility.notSelected,  "selectedLinkType=$value" , conditionalExecution.true , runAsUser.currentUser]
    addTransitionFunction( transition, 'postfunction', info?.isCloud ? cloud : server, functionKey)
}

relatedIssue.take(1).eachWithIndex { key, value, i ->
    def transition = addCommentVisibleToAdminProjectRole + i
    def cloud =  "{$conditionalExecution.false,\"targetIssue\":\"$value\",\"comment\":\"$transition\",\"restrictToInternal\":false,\"restrictToProjectRoleId\":$jiraAdminRoleId,\"runAsType\":\"currentUser\"}"
    def server =  ["valueType=template" , "value=$transition" , commentVisibility.jiraAdminRoles ,  "selectedLinkType=$value" , conditionalExecution.false , runAsUser.currentUser]
    addTransitionFunction( transition, 'postfunction', info?.isCloud ? cloud : server, functionKey)
}

relatedIssue.take(1).eachWithIndex { key, value, i ->
    def transition = addCommentVisibleToAdminGroup + i
    def cloud =  "{$conditionalExecution.false,\"targetIssue\":\"$value\",\"comment\":\"$transition\",\"restrictToInternal\":false,\"restrictToGroup\":\"$jiraAdminGroup\",\"runAsType\":\"currentUser\"}"
    def server =  ["valueType=template" , "value=$transition" , commentVisibility.jiraAdminGroups ,  "selectedLinkType=$value" , conditionalExecution.false , runAsUser.currentUser]
    addTransitionFunction( transition, 'postfunction', info?.isCloud ? cloud : server, functionKey)
}

relatedIssue.take(1).eachWithIndex { key, value, i ->
    def transition = addCommentVisibleToTestGroup + i
    def cloud =  "{$conditionalExecution.false,\"targetIssue\":\"$value\",\"comment\":\"$transition\",\"restrictToInternal\":false,\"restrictToGroup\":\"$testGroupId\",\"runAsType\":\"currentUser\"}"
    def server =  ["valueType=template" , "value=$transition" , commentVisibility.testGroupUsers ,  "selectedLinkType=$value" , conditionalExecution.false , runAsUser.currentUser]
    addTransitionFunction( transition, 'postfunction', info?.isCloud ? cloud : server, functionKey)
}

relatedIssue.take(1).eachWithIndex { key, value, i ->
    def transition = addCommentVisibleToTestProjectRole + i
    def cloud =  "{$conditionalExecution.false,\"targetIssue\":\"$value\",\"comment\":\"$transition\",\"restrictToInternal\":false,\"restrictToProjectRoleId\":$testProjectRoleId,\"runAsType\":\"currentUser\"}"
    def server =  ["valueType=template" , "value=$transition" , commentVisibility.testProjectRoleUsers ,  "selectedLinkType=$value" , conditionalExecution.false , runAsUser.currentUser]
    addTransitionFunction( transition, 'postfunction', info?.isCloud ? cloud : server, functionKey)
}

["currentUser","userFromScriptInvalid"].each {
    runAsUser.remove(it)
}

runAsUser.eachWithIndex { usersType, fieldValues, idx ->
    relatedIssue.take(1).eachWithIndex { key, value, i ->
        def transition = addCommentRunAsUser + usersType + i
        def cloud =  "{$conditionalExecution.false,\"targetIssue\":\"$value\",\"comment\":\"$transition\",\"restrictToInternal\":false,\"restrictToGroup\":\"\",$fieldValues}"
        def server =  ["valueType=template" , "value=$transition" , commentVisibility.notSelected , "selectedLinkType=$value" , conditionalExecution.false , fieldValues]
        addTransitionFunction(transition, 'postfunction', info?.isCloud ? cloud : server, functionKey)
        if (!isCloud) {
            moveTransitionFunction(transition, 4)
        }
    }
}

[
        addCommentByTemplate
].each {
    relatedIssuesMap.eachWithIndex { key, value, i ->
        def getCurrentUserName1 = info?.isCloud? info?.userDisplayName : user
        def transition = it+i
        gint.taskHelper.add([
                [action    : 'transitionIssue',
                 ext: ":By $transition:",
                 sleep: sleep,
                 parameters: [
                         issue     : key,
                         transition: transition,
                 ],
                ],
        ])
        gint.taskHelper.add([
                [action    : 'getComments',
                 ext       : ":verify the comment added by template after transition issue with :" +transition,
                 sleep     : sleep,
                 parameters: [
                         issue: value
                 ],
                 data      : [ /$transition/  ],
                ]
        ])
    }
}

runAsUser.remove("userFromScriptInvalid","currentUser")
runAsUser.eachWithIndex { userToCheck, fieldsValues, idx ->
    relatedIssuesMap.take(1).eachWithIndex { key, value, i ->
        def transition = addCommentRunAsUser + userToCheck + i
        def getCurrentUserName1 = info?.isCloud? info?.userDisplayName : user
        if(userToCheck == "userInFieldAssignee"){
            gint.taskHelper.add([
                    [action: 'setFieldValue' ,
                     ext: " : Of assignee of current issue to $user before transition issue with: " + transition,
                     sleep: sleep,
                     parameters: [
                             issue: key,
                             field : "Assignee",
                             value: user
                     ],
                    ],
            ])
        }
        gint.taskHelper.add([
                [action    : 'transitionIssue',
                 ext: ":With transition $transition:when user in field assignee is $testUser",
                 sleep: sleep,
                 parameters: [
                         issue     : key,
                         transition: transition,
                 ],
                ],
                [action: 'getComments',
                 ext: ":After transition issue with_ $transition and user in field assignee is $testUser:",
                 sleep: sleep,
                 parameters: [
                         issue: value
                 ],
                 data:[   /$getCurrentUserName1 added a comment on/,
                          /$transition/
                 ],
                ]
        ])
    }
}

[
        addCommentByExpression
].each {
    relatedIssuesMap.take(1).eachWithIndex { key, value, i ->
        def transition = it+i
        if (!isCloud) {
            gint.taskHelper.add([
                    [action    : "setFieldValue",
                     sleep: defaultSleepTime,
                     ext: ":Of description of target issue:before transition issue with_ $transition ",
                     parameters: [
                             issue: key,
                             field: "Description",
                             value: transition
                     ]
                    ],
                    [action    : 'transitionIssue',
                     ext       : ":by transition_ $transition ",
                     sleep     : defaultSleepTime,
                     parameters: [
                             issue     : key,
                             transition: transition,
                     ],
                    ],
                    [action    : 'getComments',
                     ext       : " : verify comment added after transition issue with $transition :",
                     sleep     : defaultSleepTime,
                     parameters: [
                             issue: value
                     ],
                     data      : [/$getCurrentUserName added a comment on/,
                                  /$transition/
                     ],
                    ]
            ])
        }
    }
}

[
        addCommentVisibleToTestProjectRole,
].each {
    relatedIssuesMap.take(1).eachWithIndex { key, value, i ->
        def transition = it + i
        ['addProjectRoleActors','removeProjectRoleActors'].each { action ->
            gint.taskHelper.add([
                    [action    : action,
                     ext       : ": In $testRole role user $user before transition issue with_ $transition:after $action",
                     sleep     : sleep,
                     parameters: [
                             userId : user,
                             role   : testRole,
                             project: projectName,
                             continue: null
                     ],
                    ],
            ])
            gint.taskHelper.add([
                    [action    : 'transitionIssue',
                     ext       : "by $transition:after $action",
                     sleep     : defaultSleepTime,
                     parameters: [
                             issue     : key,
                             transition: transition,
                     ],
                    ],
            ])
            if(action == 'addProjectRoleActors'){
                gint.taskHelper.add([
                        [action    : 'getComments',
                         ext       : ": verify the comment added after transition issue with:$transition:after $action",
                         sleep     : defaultSleepTime,
                         parameters: [
                                 issue: value
                         ],
                         data  : [/$transition/],
                        ]
                ])
            } else {
                gint.taskHelper.add([
                        [action    : 'getComments',
                         ext       : ": verify the comment added after transition issue with:$transition:after $action",
                         sleep     : defaultSleepTime,
                         parameters: [
                                 issue: value
                         ],
                         failData  : [/$transition/],
                        ]
                ])
            }
        }

    }
}
[
        addCommentVisibleToTestGroup
].each {
    relatedIssuesMap.take(1).eachWithIndex { key, value, i ->
        ['addUserToGroup', 'removeUserFromGroup'].each { action ->
            def transition = it + i
            gint.taskHelper.add([
                    [action    : action,
                     ext       : "$action:user $user to $testGroup",
                     sleep     : defaultSleepTime,
                     parameters: [
                             userId     : user,
                             group: testGroup,
                     ],
                    ],
            ])
            gint.taskHelper.add([
                    [action    : 'transitionIssue',
                     ext       : "by $transition:after $action",
                     sleep     : defaultSleepTime,
                     parameters: [
                             issue     : key,
                             transition: transition,
                     ],
                    ],
            ])
            if(action == 'addUserToGroup'){
                gint.taskHelper.add([
                        [action    : 'getComments',
                         ext       : ": verify the comment added after transition issue with:$transition:after $action",
                         sleep     : defaultSleepTime,
                         parameters: [
                                 issue: value
                         ],
                         data  : [/$transition/],
                        ]
                ])
            }else {
                gint.taskHelper.add([
                        [action    : 'getComments',
                         ext       : ": verify the comment added after transition issue with:$transition:after $action",
                         sleep     : defaultSleepTime,
                         parameters: [
                                 issue: value
                         ],
                         failData  : [/$transition/],
                        ]
                ])
            }

        }
    }
}

[
        addCommentVisibleToAdminProjectRole,
].each {
    relatedIssuesMap.take(1).eachWithIndex { key, value, i ->
        ['removeProjectRoleActors', 'addProjectRoleActors'].each { action ->
            def transition = it + i
            gint.taskHelper.add([
                    [action    : action,
                     ext       : ":$action in admin role user $user before transition issue with_ $transition:",
                     sleep     : sleep,
                     parameters: [
                             userId : user,
                             role   : "Administrators",
                             project: projectName
                     ],
                    ],
            ])
            gint.taskHelper.add([
                    [action    : 'transitionIssue',
                     ext       : ":By transition_ $transition:after $action",
                     sleep     : sleep,
                     parameters: [
                             issue     : key,
                             transition: it + i,
                     ],
                    ],
            ])
            if (action == 'addProjectRoleActors') {
                gint.taskHelper.add([
                        [action    : 'getComments',
                         ext       : ":Verify comment added by postfunction after transition issue with_ $transition:acter $action",
                         sleep     : defaultSleepTime,
                         parameters: [
                                 issue: value
                         ],
                         data      : [/$transition/],
                        ]
                ])
            } else {
                gint.taskHelper.add([
                        [action    : 'getComments',
                         ext       : ":Verify comment added by postfunction after transition issue with_ $transition:after $action",
                         sleep     : defaultSleepTime,
                         parameters: [
                                 issue: value
                         ],
                         failData      : [/$transition/],
                        ]
                ])
            }
        }
    }
}

[
        //addCommentVisibleToAdminGroup
].each {
    relatedIssuesMap.take(1).eachWithIndex { key, value, i ->
        def transition = it + i
        gint.taskHelper.add([
                [action    : 'transitionIssue',
                 ext       : ":By transition_ $transition:",
                 sleep     : defaultSleepTime,
                 parameters: [
                         issue     : key,
                         transition: it + i,
                 ],
                ],
        ])
        gint.taskHelper.add([
                [action    : 'getComments',
                 ext       : ":Verify comment added by postfunction after transition issue with_ $transition:",
                 sleep     : defaultSleepTime,
                 parameters: [
                         issue: value
                 ],
                 data      : [/$transition/],
                ]
        ])
    }
}

[
        addCommentIfConditionTrue
].each {
    relatedIssuesMap.take(1).eachWithIndex { key, value, i ->
        ["Low","High"].eachWithIndex { priority, idx ->
            def transition = it + i
            gint.taskHelper.add([
                    [action: 'setFieldValue' ,
                     ext: " : Of priority to $priority to current issue before transition issue with $transition:",
                     sleep: defaultSleepTime,
                     parameters: [
                             issue: key,
                             field : "Priority",
                             value: priority
                     ],
                    ],
                    [action    : 'transitionIssue',
                     ext: ":by transition_ $transition _when priority of issue is_ $priority:",
                     sleep: defaultSleepTime,
                     parameters: [
                             issue     : key,
                             transition: transition,
                     ],
                    ],
            ])
            if(priority == "High") {
                gint.taskHelper.add([
                        [action      : 'getComments',
                         ext         : ":verify the comments added by postfunction after transition issue with_ $transition _when issue priority is_ $priority:",
                         sleep       : defaultSleepTime,
                         parameters  : [
                                 issue: value
                         ],
                         data        : [/$transition/],
                        ]
                ])
            } else {
                gint.taskHelper.add([
                        [action      : 'getComments',
                         ext         : ":verify the comments added by postfunction after transition issue with_ $transition _when issue priority is_ $priority:",
                         sleep       : defaultSleepTime,
                         parameters  : [
                                 issue: value
                         ],
                         failData        : [/$transition/],
                        ]
                ])
            }
        }
    }
}





