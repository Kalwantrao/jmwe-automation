import groovy.json.JsonOutput

def importWorkflow(baseWorkflow, workflow) {
    gint.taskHelper.addSetUp([
            [
                action: 'importWorkflow',
                parameters: [
                	  workflow: workflow,
					  file: baseWorkflow
                ]
            ],
    ])
    gint.taskHelper.addTearDown('tearDownWorkflow', [
            [
                    action: 'deleteWorkflow',
                    mustRunAfter: 'deleteWorkflowScheme',
                    parameters: [
                            workflow: workflow,
                    ]
            ],
            [
                    action: 'deleteWorkflow',
                    mustRunAfter: 'deleteWorkflowScheme',
                    ext: 'copy',
                    parameters: [
                            workflow: "Copy of ${workflow}",
                    ]
            ]
    ])
}
def createTransitionsWithFunctions(transitionFunctions, transitionName, functionKey, type, startStep, workflow, screen, offset = 0)
{
    transitionFunctions.eachWithIndex { functionData, index, number = index + offset ->
        def transition = transitionName + number
        gint.taskHelper.addSetUp('setupTransitions', [
                [
                    action: 'addTransition',
                    ext: number,
                    dependsOn: ['importWorkflow', 'addScreen'],
                    end: true,
                    parameters: [
                            workflow: workflow,
                            name: transition,
                            description: 'Transition for ' + transition,
                            step: startStep,
                            screen: screen,
                    ],
                    data: [
                            "Transition '${transition}' added to workflow '${workflow}' with id ",
                    ],
                ],
                [
                        action: 'addTransitionFunction',
                        ext: number,
                        end: true,
                        parameters: [
                                workflow: workflow,
                                transition: transition,
                                functionKey: functionKey,
                                type: type,
                                step: startStep,
                                data: JsonOutput.toJson(functionData),
                        ],
                        data: [
                                "Transition function of type ${type} added to workflow '${workflow}'.",
                        ],
                ]
        ])
    }
}
def createWorkflowScheme(workflow, workflowScheme, ext) {
    gint.taskHelper.addSetUp([
            action: 'createWorkflowScheme',
            ext: ext,
            dependsOn: 'setupTransitions',
            ignoreDependsResult: true,
            parameters:[
                    workflowScheme: workflowScheme,
                    workflow: workflow,
            ],
    ])
    gint.taskHelper.addTearDown(
            action: 'deleteWorkflowScheme',
            parameters: [
                    workflowScheme: workflowScheme,
            ]
    )
}
def createScreen(screen, screenScheme, fieldList, issueTypeScreenScheme){
    gint.taskHelper.addSetUp('addScreen',[
            [
                    action:'addScreen',
                    ext: '--createScreen',
                    parameters:[
                            screen: screen,
                    ],
            ],
            [
                    action:'addScreenFields',
                    ext: '--configureScreenWithFields',
                    parameters:[
                            screen: screen,
                            field: fieldList,
                    ],
            ],
            [
                    action:'addScreenScheme',
                    ext: '--createScreenScheme',
                    parameters:[
                        screen: screen,
                        screenScheme: screenScheme,
                    ],
            ],
            [
                    action:'addIssueTypeScreenScheme',
                    ext: '--createIssueTypeScreenScheme',
                    parameters:[
                        screenScheme: screenScheme,
                        issueTypeScreenScheme: issueTypeScreenScheme,
                    ],
            ],

    ])
    gint.taskHelper.addTearDown('tearDownScreen', [
            [
                    action: 'deleteIssueTypeScreenScheme',
                    ext: '--createIssueTypeScreenScheme',
                    mustRunAfter: 'deleteProject',
                    parameters:[
                            issueTypeScreenScheme: issueTypeScreenScheme,
                    ]
            ],
            [
                    action: 'deleteIssueTypeScreenScheme',
                    ext: '--createIssueTypeScreenScheme-Scrum',
                    mustRunAfter: 'deleteProject',
                    parameters:[
                            issueTypeScreenScheme: "${issueTypeScreenScheme}: Scrum Issue Type Screen Scheme",
                    ]
            ],
            [
                    action: 'deleteIssueTypeScheme',
                    ext: '--createIssueTypeScheme-Scrum',
                    mustRunAfter: 'deleteProject',
                    parameters:[
                            issueTypeScheme: "${issueTypeScreenScheme}: Scrum Issue Type Scheme",
                    ]
            ],
            [
                    action: 'deleteScreenScheme',
                    ext: '--createScreenScheme',
                    parameters:[
                            screenScheme: screenScheme,
                    ]
            ],
            [
                    action: 'deleteScreenScheme',
                    ext: '--createScreenScheme-Bug',
                    parameters:[
                            screenScheme: "${screenScheme}: Scrum Bug Screen Scheme",
                    ]
            ],
            [
                    action: 'deleteScreenScheme',
                    ext: '--createScreenScheme-Default-Issue',
                    parameters:[
                            screenScheme: "${screenScheme}: Scrum Default Screen Scheme",
                    ]
            ],
            [
                    action: 'removeScreen',
                    ext: '--createScreen',
                    parameters:[
                            screen: screen,
                    ]
            ],
            [
                    action: 'removeScreen',
                    ext: '--createScreen-Bug',
                    parameters:[
                            screen: "${screen}: Scrum Bug Screen",
                    ]
            ],
            [
                    action: 'removeScreen',
                    ext: '--createScreen-Default-Issue',
                    parameters:[
                            screen: "${screen}: Scrum Default Issue Screen",
                    ]
            ],
    ])
}
def createProject(project, template, workflowScheme, issueTypeScreenScheme, permissionScheme, ext) {
    gint.taskHelper.addSetUp('createProject', [[
            action: 'createProject' ,
            ext: ext,
            dependsOn: ['permission', 'addScreen'],
            ignoreDependsResult: true,
            parameters:[
                    project: project,
                    template: template,
                    lead: '@Self',
                    workflowScheme: workflowScheme,
                    issueTypeScreenScheme: issueTypeScreenScheme,
                    permissionScheme: permissionScheme,
//			 issueSecurityScheme: issueSecurityScheme,
            ],
    ]])
    gint.taskHelper.addTearDown('tearDownProject',
            [[
                     action: 'deleteProject',
                     parameters:[
                             project: project,
                     ],
             ]],
    )
    gint.taskHelper.addTearDown('deleteIssues', [
            [ name: "Delete issues For Users",
              action: 'runFromIssueList',
              parameters: [
                      jql: 'summary ~ JMWE_Issue_User',
                      common: "-a deleteIssue --issue @issue@ --outputFormat 999",
              ],
            ]
    ])
}

def createVersions(project, numberOfVersions) {
    (1..numberOfVersions).each{ versionNumber ->
        gint.taskHelper.addSetUp(
                action: 'addVersion',
                ext: versionNumber,
                dependsOn: 'createProject',
                group:'add',
                project: project,
                parameters:[
                        version: versionNumber,
                ],
                data:[
                        ~/Version '${versionNumber}' with id \d+ added to project ${project} as the last version./
                ],
        )
    }
}

def createComponents(project, componentName, numberOfComponents) {
    (1..numberOfComponents).each{ componentNumber ->
        gint.taskHelper.addSetUp(
                action: 'addComponent',
                ext: componentNumber,
                dependsOn: 'createProject',
                group:'add',
                project: project,
                parameters:[
                        component: componentName + componentNumber,
                ],
                data:[
                        ~/Component '${componentName + componentNumber}' with id \d+ added to project ${project}./
                ],
        )
    }
}
def createPermissionScheme(permissionScheme, permissions, ext) {
    gint.taskHelper.addSetUp('permission',[
            [
                    action: 'createPermissionScheme',
                    ext: ext,
                    parameters:[
                        permissionScheme: permissionScheme,
                    ],
            ],
    ])
    permissions.eachWithIndex { String permission, int number ->
        gint.taskHelper.add('setPermissionsToUser',[
                [
                        action:'addPermission',
                        ext: 'setPermissionsToUser'+number,
                        dependsOn: 'permission',
                        parameters:[
                                permissionScheme: permissionScheme,
                                permission: permission,
                                group: 'jira-software-users',
                        ],
                ],
        ])
    }
    gint.taskHelper.addTearDown('tearDownPermission',
            [[
                     action: 'deletePermissionScheme',
                     parameters:[
                             permissionScheme: permissionScheme,
                     ],
             ]],
    )
}
def createUsers(userId, userEmail, projectRole, project, groupName) {
    {
        gint.taskHelper.addSetUp('addUsersSetUp',[
                /*[action: 'addGroup',
                 dependsOn: "addUser",
                 parameters:[
                         group: groupName
                     ]
                ],
                [action: 'addUserToGroup',
                 dependsOn: "addGroup",
                 parameters:[
                         userId: userId,
                         group: groupName
                      ]
                ]
                */
        ]
)
        gint.taskHelper.addTearDown('addUsersTearDown', [
                [action: 'removeUser',
                 dependsOn: "deleteProject",
                     parameters:[
                     userId: userId,
                     ],
                ],
                [action: 'addUser',
                 dependsOn: "removeUser",
                 parameters:[
                         userId: userId,
                         userEmail: userEmail,
                         userPassword: userId
                 ],
                ],
                [action: 'removeProjectRole',
                 dependsOn: "deleteProject",
                 parameters:[
                    name:  projectRole
                    ]
                ],
                [action: 'removeProjectRoleActors',
                 dependsOn: "deleteProject",
                 parameters:[
                    project: project,
                    role: projectRole,
                    userId: userId
                    ]
                ],
                [action: 'removeGroup',
                 dependsOn: "deleteProject",
                 parameters:[
                    group: groupName
                ]
                ],
                [action: 'removeUserFromGroup',
                 dependsOn: "deleteProject",
                   parameters:[
                   userId: userId,
                   group: groupName
                   ]
                ]
             ]
      )
    }
}
def createIssue(project, parametersList,ext) {
    def savedIssues = [:]
    parametersList.eachWithIndex { parameters, number ->
        gint.taskHelper.add('createIssues',[
                [action: 'createIssue', ext: ext + number,//parameters["type"] + number,
                group: 'create',
                project: project,
                parameters: parameters,
                stopOnFail: true,
                finalClosure: { Task task ->
                    def currentIssue = gint.searchForIssueKey(task.outData)
                    savedIssues[number] = currentIssue
                    gint.helper.logVarWithFormat('Create Issues to validate the comment required validator')
                },
              ],
        ])
    }
    return savedIssues
}
def linkIssues(parameters, ext) {
		gint.taskHelper.add('linkIssues',[
				[action: 'linkIssue', ext: ext,
					group: 'link',
					parameters: parameters,
					stopOnFail: true
                ]
		 ])
}
def transitionIssue(transition, issueToTransition, expected, ext, fields, data) {
    gint.taskHelper.add('transitionIssues', [
            [action    : 'transitionIssue', ext: ext,
             dependsOn : ['createIssues'],
             ignoreDependsResult: true,
             expected: expected,
             parameters: [
                     issue  : issueToTransition,
                     transition: transition,
             ]+ (fields != null ? fields : [:]),
             data: ( data == null ? data : [:]),
            ],
    ]
    )
}
def getIssueInformation(issueToCheck, data, ext) {
    gint.taskHelper.add('getIssueInformation',[
            [action: 'getIssue', ext: ext ,
             dependsOn: 'transitionIssues',
             parameters: [
                     issue: issueToCheck,
             ],
             data: [ data ],
            ],
    ])
}
def getComments(issueToCheckComments, expected, user, ext){
    gint.taskHelper.add('checkComments',[
            [action: 'getComments', ext: ext,
             expected: expected,
             dependsOn: 'transitionIssues',
             //mustRunAfter: 'setFields',
             parameters: [
                     issue: issueToCheckComments,
             ],
             data: [~/$user added a comment/],
            ],
    ])
}
def checkCommentVisibleToUser(issue, userId, user, ext) {
        gint.taskHelper.add('checkCommentVisibleToUser', [
                [action: 'getComments',ext: ext + 'checkCurrentUser',
                 dependsOn: 'transitionIssues',
                 parameters:[
                         issue: issue
                 ],
                 data: [~/$user added a comment/],
                ],
                [dependsOn: 'transitionIssues', cmd : /acli $userId -a getComments --issue $issue /,
                 failData: [~/$user added a comment/]]
        ]
        )
    }
def transitionByUserTask(transition, userId, issue, data, expected ) {
    gint.taskHelper.add('transitionByUser', [
            [expected: expected, name: 'transitionTriggerByOtherUser', cmd : /acli $userId -a transitionIssue --issue $issue --transition $transition/,
            data: ( data == null ? data : [:]), ]
    ]
    )
}
def checkRunAsUser(transition, issue, userId) {
    gint.taskHelper.add('checkRunAsUser', [
            [name:'checkRunAsUser',dependsOn:'transitionIssues', cmd : /acli $userId -a transitionIsue --issue $issue --transition $transition/,],
            [cmd: /acli ${userId} getIssueHistoryList --issue ${issue} /,
             data:[$/'userId'/$],
           ],
    ],
    )
}
def updateIssues( issue, parameters, ext){
    gint.taskHelper.add('setFields',[
            [action: 'updateIssue', ext: ext,
                dependsOn: 'createIssues',
                mustRunBefore: 'transitionIssues',
                issue: issue,
                parameters: parameters,
            ],
    ]
    )
}
def getIssueHistoryList(issue, userId, ext){
    gint.taskHelper.add('getIssueHistoryList',[
            [action: 'getIssueHistoryList', ext: ext,
                mustRunAfter: 'transitionIssues',
                parameters: [
                        issue: issue,
                ],
                    data: [ "$userId" ]
            ]
    ])
}
def getLinkedIssueList(currentIssue, numberOfLinkedIssues, ext, linkType, link){
    gint.taskHelper.add('getLinkIssues',[
            [action: 'getLinkList', ext: ext,
                dependsOn: 'transitionIssues',
                parameters: [
                        issue: currentIssue,
                ],
                data: [/$numberOfLinkedIssues links for issue: $currentIssue/,
                       "$currentIssue","$linkType","$link"]
            ]
    ]
    )
}
def transitionToStatus(issue, previousStatus, currentStatus, ext){
    gint.taskHelper.add('setIssueStatus',[
            [action: 'transitionIssue', ext: 'previous' + ext,
                mustRunBefore: 'transitionIssues',
                parameters: [
                        issue: issue,
                        transition: previousStatus,
                ]
            ],
            [action: 'transitionIssue', ext: 'current' + ext,
             mustRunBefore: 'transitionIssues',
             parameters: [
                     issue: issue,
                     transition: currentStatus,
             ]
            ]
    ]

    )
}
ext {
    importWorkflow= this.&importWorkflow
    createWorkflowScheme= this.&createWorkflowScheme
    createProject= this.&createProject
    createPermissionScheme= this.&createPermissionScheme
    createUsers= this.&createUsers
    createVersions= this.&createVersions
    createComponents= this.&createComponents
    createScreen= this.&createScreen
    createTransitionsWithFunctions= this.&createTransitionsWithFunctions
    createIssue= this.&createIssue
    linkIssues= this.&linkIssues
    transitionIssue= this.&transitionIssue
    getIssueInformation= this.&getIssueInformation
    getComments= this.&getComments
    checkCommentVisibleToUser= this.&checkCommentVisibleToUser
    transitionByUserTask= this.&transitionByUserTask
    checkRunAsUser= this.&checkRunAsUser
    updateIssues= this.&updateIssues
    getLinkedIssueList =this.&getLinkedIssueList
    transitionToStatus =this.&transitionToStatus
    getIssueHistoryList= this.&getIssueHistoryList
  }